<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Voter Management • Admin Console
  </title>
  <!-- Brand Typography: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome 6 -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
   <!-- Global Theme Styles -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page Specific Styles -->
   <link href="static/voter_management.css" rel="stylesheet"/>
  </link>
 </head>
 <body class="d-flex flex-column min-vh-100">
  <!-- Header (Admin) -->
  <nav class="navbar navbar-expand-lg app-header-admin shadow-sm">
   <div class="container-fluid">
    <button aria-controls="appSidebarAdmin" aria-expanded="false" aria-label="Toggle sidebar" class="btn btn-outline-light d-lg-none me-2" data-bs-target="#appSidebarAdmin" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="/admin">
     <img alt="Logo" class="me-2" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
     Admin Console
    </a>
    <button aria-controls="adminNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#adminNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="adminNav">
     <form action="/admin/elections" class="d-none d-md-flex ms-auto me-3" role="search">
      <div class="input-group input-group-sm">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search" class="form-control" name="q" placeholder="Search elections or voters" type="search"/>
      </div>
     </form>
     <ul class="navbar-nav align-items-center">
      <li class="nav-item me-2 d-none d-md-block">
       <a class="btn btn-light btn-sm" href="/admin/elections/create">
        <i class="fa-solid fa-plus me-1">
        </i>
        Create Election
       </a>
      </li>
      <li class="nav-item me-2 position-relative">
       <a aria-label="Notifications" class="nav-link" href="#">
        <i class="fa-regular fa-bell">
        </i>
        <span class="notif-dot">
        </span>
       </a>
      </li>
      <li class="nav-item dropdown">
       <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="adminProfileMenu" role="button">
        <img alt="Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=40" style="width:28px;height:28px"/>
        <span>
         Alex Smith
        </span>
       </a>
       <ul class="dropdown-menu dropdown-menu-end">
        <li>
         <h6 class="dropdown-header">
          Administrator
         </h6>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-gear me-2">
          </i>
          Settings
         </a>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-book-open-reader me-2">
          </i>
          Admin Guide
         </a>
        </li>
        <li>
         <hr class="dropdown-divider"/>
        </li>
        <li>
         <a class="dropdown-item" href="./index.html">
          <i class="fa-solid fa-right-from-bracket me-2">
          </i>
          Logout
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <!-- Main Content Area with Sidebar -->
  <div class="container-fluid flex-grow-1">
   <div class="d-flex">
    <!-- Sidebar (Admin) -->
  <aside class="app-sidebar-admin collapse d-lg-block" id="appSidebarAdmin">
    
    <div class="p-3">
     <div class="d-flex align-items-center mb-3">
      <img alt="Admin Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
      <div>
       <div class="fw-semibold" id="adminName">
        Alex Smith
       </div>
       <div class="text-muted small">
        Administrator
       </div>
      </div>
     </div>
     <div class="mb-2 section-title text-uppercase">
      Overview
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link active" href="./admin_dashboard.html">
        <i class="fa-solid fa-gauge-high fa-fw me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Elections
     </div>
     <ul class="nav flex-column mb-1">
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html">
        <i class="fa-solid fa-list-check fa-fw me-2">
        </i>
        All Elections
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./election_creation.html">
        <i class="fa-solid fa-plus fa-fw me-2">
        </i>
        Create New
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html?status=active">
        <i class="fa-solid fa-signal fa-fw me-2">
        </i>
        Active &amp; Monitoring
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html?status=completed">
        <i class="fa-solid fa-chart-column fa-fw me-2">
        </i>
        Completed &amp; Results
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase mt-3">
      Voters
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html">
        <i class="fa-solid fa-users fa-fw me-2">
        </i>
        Manage Voters
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html?status=pending">
        <i class="fa-solid fa-user-check fa-fw me-2">
        </i>
        Pending Approvals
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Resources
     </div>
     <ul class="nav flex-column">
      <li class="nav-item">
       <a class="nav-link" href="./admin_guide.html" onclick="return false;">
        <i class="fa-solid fa-book-open-reader fa-fw me-2">
        </i>
        Admin Guide
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./privacy.html">
        <i class="fa-solid fa-shield-halved fa-fw me-2">
        </i>
        Privacy
       </a>
      </li>
     </ul>
    </div>
   </aside>
    <!-- Main Panel -->
    <main class="main-panel flex-grow-1">
     <!-- Breadcrumb -->
     <nav aria-label="breadcrumb" class="breadcrumb container-max">
      <ol class="breadcrumb mb-2">
       <li class="breadcrumb-item">
        <a href="./admin_dashboard.html">
         Admin Dashboard
        </a>
       </li>
       <li aria-current="page" class="breadcrumb-item active">
        Voter Management
       </li>
      </ol>
     </nav>
     <!-- Page Header -->
     <div class="page-header container-max">
      <div class="d-flex align-items-center gap-3">
       <h1 class="page-title mb-0">
        Voter Management
       </h1>
       <span class="badge-soft info" id="activeFilterBadge">
        Pending
       </span>
      </div>
      <div class="d-flex align-items-center gap-2">
       <button class="btn btn-light btn-sm" id="exportCsvBtn">
        <i class="fa-solid fa-file-export me-1">
        </i>
        Export CSV
       </button>
      </div>
     </div>
     <!-- Top Metrics & Trend -->
     <div class="container-max mb-4">
      <div class="row g-3">
       <div class="col-6 col-md-3">
        <div class="metric-card text-center">
         <div class="metric-title">
          Total Voters
         </div>
         <div class="metric-value" id="metricTotal">
          —
         </div>
        </div>
       </div>
       <div class="col-6 col-md-3">
        <div class="metric-card text-center">
         <div class="metric-title">
          Pending
         </div>
         <div class="metric-value text-warning" id="metricPending">
          —
         </div>
        </div>
       </div>
       <div class="col-6 col-md-3">
        <div class="metric-card text-center">
         <div class="metric-title">
          Approved
         </div>
         <div class="metric-value text-success" id="metricApproved">
          —
         </div>
        </div>
       </div>
       <div class="col-6 col-md-3">
        <div class="metric-card text-center">
         <div class="metric-title">
          Rejected
         </div>
         <div class="metric-value text-danger" id="metricRejected">
          —
         </div>
        </div>
       </div>
      </div>
      <div class="card mt-3">
       <div class="card-header">
        <div class="widget-title">
         Registrations (Last 14 days)
        </div>
       </div>
       <div class="card-body">
        <canvas aria-label="Registration trend chart" height="80" id="trendChart" role="img">
        </canvas>
       </div>
      </div>
     </div>
     <!-- Filter & Search Controls -->
     <div class="container-max app-card mb-3">
      <div class="card-body">
       <div class="row g-2 align-items-center">
        <div class="col-12 col-lg-6">
         <form class="search-form" id="searchForm" onsubmit="return false;">
          <div class="input-group">
           <span class="input-group-text">
            <i class="fa-solid fa-magnifying-glass">
            </i>
           </span>
           <input aria-label="Search voters" autocomplete="off" class="form-control" id="searchInput" placeholder="Search by name or unique ID" type="text">
           </input>
          </div>
         </form>
        </div>
        <div class="col-12 col-lg-6 d-flex justify-content-lg-end gap-2">
         <button class="btn btn-success" disabled="" id="approveSelectedBtn">
          <i class="fa-solid fa-circle-check me-1">
          </i>
          Approve Selected
         </button>
         <button class="btn btn-danger" disabled="" id="rejectSelectedBtn">
          <i class="fa-solid fa-circle-xmark me-1">
          </i>
          Reject Selected
         </button>
         <button class="btn btn-info text-white" id="bulkUploadBtn">
          <i class="fa-solid fa-file-arrow-up me-1">
          </i>
          Bulk Upload Voters
         </button>
        </div>
       </div>
       <!-- Status Filter Tabs -->
       <ul class="nav nav-tabs mt-3" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
         <button class="nav-link" data-status="All" id="tab-all" role="tab" type="button">
          <i class="fa-solid fa-layer-group me-1">
          </i>
          All
         </button>
        </li>
        <li class="nav-item" role="presentation">
         <button class="nav-link active" data-status="Pending" id="tab-pending" role="tab" type="button">
          <i class="fa-solid fa-hourglass-half me-1">
          </i>
          Pending
         </button>
        </li>
        <li class="nav-item" role="presentation">
         <button class="nav-link" data-status="Approved" id="tab-approved" role="tab" type="button">
          <i class="fa-solid fa-circle-check me-1">
          </i>
          Approved
         </button>
        </li>
        <li class="nav-item" role="presentation">
         <button class="nav-link" data-status="Rejected" id="tab-rejected" role="tab" type="button">
          <i class="fa-solid fa-circle-xmark me-1">
          </i>
          Rejected
         </button>
        </li>
       </ul>
      </div>
     </div>
     <!-- Data Table Card -->
     <div class="container-max card">
      <div class="card-header">
       <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center gap-2">
         <span class="widget-title">
          Voters
         </span>
         <span class="text-muted small" id="tableSubtitle">
          —
         </span>
        </div>
        <div class="d-flex align-items-center gap-2">
         <label class="form-label mb-0 me-1 small text-muted" for="itemsPerPage">
          Rows:
         </label>
         <select class="form-select form-select-sm" id="itemsPerPage" style="width:auto">
          <option selected="" value="8">
           8
          </option>
          <option value="12">
           12
          </option>
          <option value="20">
           20
          </option>
         </select>
        </div>
       </div>
      </div>
      <div class="card-body p-0">
       <div class="table-responsive">
        <table class="table table-theme mb-0 align-middle" id="votersTable">
         <thead>
          <tr>
           <th style="width:42px">
            <input aria-label="Select all" class="form-check-input" id="selectAll" type="checkbox"/>
           </th>
           <th class="sortable" data-col="name" role="button">
            Name
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable" data-col="unique_id" role="button">
            Unique ID
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable d-none d-md-table-cell" data-col="email" role="button">
            Email
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable" data-col="status" role="button">
            Status
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable" data-col="registration_date" role="button">
            Registered
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="text-end" style="width:220px;">
            Actions
           </th>
          </tr>
         </thead>
         <tbody id="tableBody">
          <!-- Rows injected by JS -->
         </tbody>
        </table>
       </div>
       <!-- Loading overlay -->
       <div class="loading-overlay d-none" id="tableLoadingOverlay">
        <div aria-label="Loading" aria-live="polite" class="spinner-border text-primary" role="status">
        </div>
        <div class="mt-2 text-muted small">
         Loading voters…
        </div>
       </div>
      </div>
      <div class="card-footer d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
       <div class="text-muted small" id="paginationInfo">
        —
       </div>
       <nav aria-label="Table pagination">
        <ul class="pagination pagination-sm mb-0" id="pagination">
        </ul>
       </nav>
      </div>
     </div>
     <!-- System Alert Placeholder -->
     <div aria-atomic="true" aria-live="polite" class="container-max mt-3" id="alertPlaceholder">
     </div>
    </main>
   </div>
  </div>
  <!-- Footer (Admin) -->
  <footer class="app-footer-admin py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="mb-2 mb-md-0">
     <a class="btn btn-outline-secondary btn-sm me-2" href="/admin/elections/create">
      <i class="fa-solid fa-plus me-1">
      </i>
      Create Election
     </a>
     <a class="btn btn-outline-secondary btn-sm" href="/admin/voters">
      <i class="fa-solid fa-users me-1">
      </i>
      Manage Voters
     </a>
    </div>
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:18px"/>
     <small class="me-3">
      © 2025 FaceID Voting
     </small>
     <a class="small me-3" href="./terms.html">
      Terms
     </a>
     <a class="small" href="./privacy.html">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Voter Details Modal (Bootstrap) -->
  <div aria-hidden="true" aria-labelledby="voterDetailsLabel" class="modal fade" id="voterDetailsModal" tabindex="-1">
   <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
     <div class="modal-header bg-light">
      <h5 class="modal-title" id="voterDetailsLabel">
       Voter Details
      </h5>
      <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
      </button>
     </div>
     <div class="modal-body">
      <div class="row g-3">
       <div class="col-12 col-md-4 text-center">
        <img alt="Voter Face Image" class="img-fluid rounded border" id="voterFaceImg" onerror="this.onerror=null;this.src='https://picsum.photos/seed/placeholder/300/300?grayscale';" src="">
        </img>
       </div>
       <div class="col-12 col-md-8">
        <dl class="row mb-0">
         <dt class="col-sm-4">
          Name
         </dt>
         <dd class="col-sm-8" id="detailName">
          —
         </dd>
         <dt class="col-sm-4">
          Unique ID
         </dt>
         <dd class="col-sm-8" id="detailUID">
          —
         </dd>
         <dt class="col-sm-4">
          Email
         </dt>
         <dd class="col-sm-8" id="detailEmail">
          —
         </dd>
         <dt class="col-sm-4">
          Status
         </dt>
         <dd class="col-sm-8" id="detailStatus">
          —
         </dd>
         <dt class="col-sm-4">
          Registered
         </dt>
         <dd class="col-sm-8" id="detailRegistered">
          —
         </dd>
        </dl>
       </div>
      </div>
     </div>
     <div class="modal-footer">
      <button class="btn btn-light" data-bs-dismiss="modal" type="button">
       Close
      </button>
      <button class="btn btn-danger" id="detailRejectBtn" type="button">
       <i class="fa-solid fa-circle-xmark me-1">
       </i>
       Reject
      </button>
      <button class="btn btn-success" id="detailApproveBtn" type="button">
       <i class="fa-solid fa-circle-check me-1">
       </i>
       Approve
      </button>
     </div>
    </div>
   </div>
  </div>
  <!-- Toasts container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
   <div aria-atomic="true" aria-live="polite" class="toast align-items-center text-bg-primary border-0" id="liveToast" role="status">
    <div class="d-flex">
     <div class="toast-body" id="toastBody">
      Action completed.
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <script>
   // State
let allVoters = [];
let filtered = [];
let currentFilter = 'Pending';
let searchTerm = '';
let sortColumn = 'registration_date';
let sortDirection = 'desc';
let currentPage = 1;
let itemsPerPage = 8;
const selectedIds = new Set();

// Elements
const tableBody = document.getElementById('tableBody');
const pagination = document.getElementById('pagination');
const paginationInfo = document.getElementById('paginationInfo');
const selectAll = document.getElementById('selectAll');
const approveSelectedBtn = document.getElementById('approveSelectedBtn');
const rejectSelectedBtn = document.getElementById('rejectSelectedBtn');
const searchInput = document.getElementById('searchInput');
const tableSubtitle = document.getElementById('tableSubtitle');
const itemsPerPageSelect = document.getElementById('itemsPerPage');
const loadingOverlay = document.getElementById('tableLoadingOverlay');
const activeFilterBadge = document.getElementById('activeFilterBadge');

// Modal elements
const detailsModalEl = document.getElementById('voterDetailsModal');
const detailsModal = new bootstrap.Modal(detailsModalEl);
let detailsVoterId = null;
const detailApproveBtn = document.getElementById('detailApproveBtn');
const detailRejectBtn = document.getElementById('detailRejectBtn');

// Toast
const toastEl = document.getElementById('liveToast');
const toast = new bootstrap.Toast(toastEl, {
    delay: 2500
});
const toastBody = document.getElementById('toastBody');

// Mock Data
function seedData() {
    const data = [{
        id: 'V-1001',
        name: 'Sophia Nguyen',
        unique_id: 'UID-4F17A',
        email: 's.nguyen@example.com',
        status: 'Pending',
        registration_date: '2025-01-12T09:21:00Z',
        face_image_url: 'https://picsum.photos/id/1027/300/300'
    }, {
        id: 'V-1002',
        name: 'Liam Johnson',
        unique_id: 'UID-7B29K',
        email: 'liam.j@example.com',
        status: 'Approved',
        registration_date: '2025-01-05T14:05:00Z',
        face_image_url: 'https://picsum.photos/id/1005/300/300'
    }, {
        id: 'V-1003',
        name: 'Ava Martinez',
        unique_id: 'UID-9C88X',
        email: 'ava.m@example.com',
        status: 'Pending',
        registration_date: '2025-01-15T11:42:00Z',
        face_image_url: 'https://picsum.photos/id/1011/300/300'
    }, {
        id: 'V-1004',
        name: 'Noah Kim',
        unique_id: 'UID-2D61P',
        email: 'noah.kim@example.com',
        status: 'Rejected',
        registration_date: '2025-01-03T08:01:00Z',
        face_image_url: 'https://picsum.photos/id/1012/300/300'
    }, {
        id: 'V-1005',
        name: 'Isabella Rossi',
        unique_id: 'UID-8E50Q',
        email: 'isa.rossi@example.com',
        status: 'Approved',
        registration_date: '2024-12-29T16:20:00Z',
        face_image_url: 'https://picsum.photos/id/1001/300/300'
    }, {
        id: 'V-1006',
        name: 'Ethan Chen',
        unique_id: 'UID-3A14M',
        email: 'ethan.chen@example.com',
        status: 'Pending',
        registration_date: '2025-01-18T10:15:00Z',
        face_image_url: 'https://picsum.photos/id/1014/300/300'
    }, {
        id: 'V-1007',
        name: 'Mia Patel',
        unique_id: 'UID-6Z73R',
        email: 'mia.patel@example.com',
        status: 'Approved',
        registration_date: '2025-01-11T13:31:00Z',
        face_image_url: 'https://picsum.photos/id/1025/300/300'
    }, {
        id: 'V-1008',
        name: 'James Brown',
        unique_id: 'UID-5X90S',
        email: 'j.brown@example.com',
        status: 'Pending',
        registration_date: '2025-01-17T09:55:00Z',
        face_image_url: 'https://picsum.photos/id/1021/300/300'
    }, {
        id: 'V-1009',
        name: 'Olivia Garcia',
        unique_id: 'UID-1Q22N',
        email: 'olivia.g@example.com',
        status: 'Rejected',
        registration_date: '2025-01-02T12:45:00Z',
        face_image_url: 'https://picsum.photos/id/1003/300/300'
    }, {
        id: 'V-1010',
        name: 'Benjamin Lee',
        unique_id: 'UID-0V11H',
        email: 'ben.lee@example.com',
        status: 'Approved',
        registration_date: '2025-01-10T18:10:00Z',
        face_image_url: 'https://picsum.photos/id/1010/300/300'
    }, {
        id: 'V-1011',
        name: 'Charlotte Davis',
        unique_id: 'UID-7M65T',
        email: 'charlotte.d@example.com',
        status: 'Pending',
        registration_date: '2025-01-19T07:25:00Z',
        face_image_url: 'https://picsum.photos/id/1020/300/300'
    }, {
        id: 'V-1012',
        name: 'Henry Wilson',
        unique_id: 'UID-4L39C',
        email: 'henry.w@example.com',
        status: 'Approved',
        registration_date: '2025-01-06T15:00:00Z',
        face_image_url: 'https://picsum.photos/id/1024/300/300'
    }];
    allVoters = data;
    updateMetrics();
}

function updateMetrics() {
    const total = allVoters.length;
    const pending = allVoters.filter(v => v.status === 'Pending').length;
    const approved = allVoters.filter(v => v.status === 'Approved').length;
    const rejected = allVoters.filter(v => v.status === 'Rejected').length;
    document.getElementById('metricTotal').textContent = total;
    document.getElementById('metricPending').textContent = pending;
    document.getElementById('metricApproved').textContent = approved;
    document.getElementById('metricRejected').textContent = rejected;
}

function showLoading(show) {
    loadingOverlay.classList.toggle('d-none', !show);
}

function sanitizeInput(str) {
    return str.replace(/[<>"'`]/g, '');
}

function formatDate(iso) {
    try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return iso;
    }
}

function applyFilterAndSearch() {
    const q = searchTerm.toLowerCase();
    filtered = allVoters.filter(v => {
        const matchesFilter = currentFilter === 'All' ? true : v.status === currentFilter;
        const matchesSearch = !q || (v.name.toLowerCase().includes(q) || v.unique_id.toLowerCase().includes(q));
        return matchesFilter && matchesSearch;
    });
}

function applySort() {
    filtered.sort((a, b) => {
        const dir = sortDirection === 'asc' ? 1 : -1;
        let va = a[sortColumn],
            vb = b[sortColumn];
        if (sortColumn === 'registration_date') {
            va = new Date(va).getTime();
            vb = new Date(vb).getTime();
        } else {
            va = ('' + va).toLowerCase();
            vb = ('' + vb).toLowerCase();
        }
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
    });
}

function paginate(arr) {
    const total = arr.length;
    const totalPages = Math.max(1, Math.ceil(total / itemsPerPage));
    if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * itemsPerPage;
    return {
        pageItems: arr.slice(start, start + itemsPerPage),
        total,
        totalPages,
        startIndex: start
    };
}

function statusBadge(status) {
    const map = {
        'Pending': '<span class="badge-soft warning">Pending</span>',
        'Approved': '<span class="badge-soft success">Approved</span>',
        'Rejected': '<span class="badge-soft error">Rejected</span>'
    };
    return map[status] || status;
}

function renderTable() {
    showLoading(false);
    applyFilterAndSearch();
    applySort();
    const {
        pageItems,
        total,
        totalPages,
        startIndex
    } = paginate(filtered);

    tableBody.innerHTML = '';
    pageItems.forEach(v => {
        const isPending = v.status === 'Pending';
        const isChecked = selectedIds.has(v.id) ? 'checked' : '';
        const rowClass = isPending ? 'alarm' : '';
        const emailCell = `<td class="d-none d-md-table-cell">${v.email}</td>`;

        const actions = `
          <div class="d-flex gap-1 justify-content-end">
            <button class="btn btn-sm btn-light" data-action="details" data-id="${v.id}"><i class="fa-regular fa-eye me-1"></i>Details</button>
            <button class="btn btn-sm btn-success" data-action="approve" data-id="${v.id}" ${isPending ? '' : 'disabled'}><i class="fa-solid fa-circle-check"></i></button>
            <button class="btn btn-sm btn-danger" data-action="reject" data-id="${v.id}" ${isPending ? '' : 'disabled'}><i class="fa-solid fa-circle-xmark"></i></button>
          </div>`;

        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td><input type="checkbox" class="form-check-input row-select" data-id="${v.id}" ${isChecked} aria-label="Select ${v.name}"></td>
          <td>${v.name}</td>
          <td>${v.unique_id}</td>
          ${emailCell}
          <td>${statusBadge(v.status)}</td>
          <td>${formatDate(v.registration_date)}</td>
          <td class="text-end">${actions}</td>
        `;
        tableBody.appendChild(tr);
    });

    const from = total === 0 ? 0 : startIndex + 1;
    const to = startIndex + pageItems.length;
    paginationInfo.textContent = `Showing ${from}-${to} of ${total}`;
    tableSubtitle.textContent = `${filtered.length} result(s)`;
    activeFilterBadge.textContent = currentFilter;

    renderPagination(totalPages);
    updateBulkButtonsState();
}

function renderPagination(totalPages) {
    pagination.innerHTML = '';
    const addItem = (label, page, disabled = false, active = false, aria = '') => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        if (aria) a.setAttribute('aria-label', aria);
        a.textContent = label;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            if (disabled) return;
            currentPage = page;
            renderTable();
        });
        li.appendChild(a);
        pagination.appendChild(li);
    };
    addItem('«', Math.max(1, currentPage - 1), currentPage === 1, false, 'Previous');
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
            addItem(String(i), i, false, i === currentPage);
        } else if (i === 2 && currentPage > 3 || i === totalPages - 1 && currentPage < totalPages - 2) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">…</span>';
            pagination.appendChild(li);
        }
    }
    addItem('»', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false, 'Next');
}

function updateBulkButtonsState() {
    const hasSelection = selectedIds.size > 0;
    approveSelectedBtn.disabled = !hasSelection;
    rejectSelectedBtn.disabled = !hasSelection;
    selectAll.checked = hasSelection && filtered.length > 0 && filtered.every(v => selectedIds.has(v.id));
}

function onHeaderSort(e) {
    const th = e.target.closest('.sortable');
    if (!th) return;
    const col = th.getAttribute('data-col');
    if (!col) return;
    if (sortColumn === col) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = col;
        sortDirection = 'asc';
    }
    document.querySelectorAll('th.sortable i').forEach(i => i.className = 'fa-solid fa-sort ms-1');
    const icon = th.querySelector('i');
    if (icon) icon.className = sortDirection === 'asc' ? 'fa-solid fa-arrow-up-short-wide ms-1' : 'fa-solid fa-arrow-down-wide-short ms-1';
    renderTable();
}

function attachTableEvents() {
    document.getElementById('votersTable').addEventListener('click', (e) => {
        const cb = e.target.closest('.row-select');
        if (cb) {
            const id = cb.getAttribute('data-id');
            if (cb.checked) selectedIds.add(id);
            else selectedIds.delete(id);
            updateBulkButtonsState();
            return;
        }
        const actionBtn = e.target.closest('button[data-action]');
        if (actionBtn) {
            const id = actionBtn.getAttribute('data-id');
            const action = actionBtn.getAttribute('data-action');
            if (action === 'approve') approveVoter(id);
            if (action === 'reject') rejectVoter(id);
            if (action === 'details') openDetails(id);
        }
    });
}

function openDetails(id) {
    const v = allVoters.find(x => x.id === id);
    if (!v) return;
    detailsVoterId = id;
    document.getElementById('voterFaceImg').src = v.face_image_url || 'https://picsum.photos/seed/placeholder/300/300?grayscale';
    document.getElementById('detailName').textContent = v.name;
    document.getElementById('detailUID').textContent = v.unique_id;
    document.getElementById('detailEmail').textContent = v.email;
    document.getElementById('detailStatus').innerHTML = statusBadge(v.status);
    document.getElementById('detailRegistered').textContent = formatDate(v.registration_date);
    detailApproveBtn.disabled = v.status !== 'Pending';
    detailRejectBtn.disabled = v.status !== 'Pending';
    detailsModal.show();
}

function approveVoter(id) {
    const v = allVoters.find(x => x.id === id);
    if (!v || v.status !== 'Pending') return;
    Swal.fire({
        title: 'Approve voter?',
        text: `${v.name} (${v.unique_id}) will be marked as Approved.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Approve',
        confirmButtonColor: '#198754'
    }).then(res => {
        if (res.isConfirmed) {
            v.status = 'Approved';
            selectedIds.delete(v.id);
            updateMetrics();
            renderTable();
            showToast('Voter approved successfully.');
        }
    });
}

function rejectVoter(id) {
    const v = allVoters.find(x => x.id === id);
    if (!v || v.status !== 'Pending') return;
    Swal.fire({
        title: 'Reject voter?',
        input: 'text',
        inputLabel: 'Reason for rejection (optional)',
        inputPlaceholder: 'e.g., Face verification failed',
        showCancelButton: true,
        confirmButtonText: 'Reject',
        confirmButtonColor: '#dc3545'
    }).then(res => {
        if (res.isConfirmed) {
            v.status = 'Rejected';
            selectedIds.delete(v.id);
            updateMetrics();
            renderTable();
            showToast('Voter rejected.');
        }
    });
}

function approveSelected() {
    const ids = Array.from(selectedIds);
    if (!ids.length) return;
    Swal.fire({
        title: 'Approve selected voters?',
        text: `${ids.length} voter(s) will be approved.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Approve',
        confirmButtonColor: '#198754'
    }).then(res => {
        if (res.isConfirmed) {
            ids.forEach(id => {
                const v = allVoters.find(x => x.id === id);
                if (v && v.status === 'Pending') v.status = 'Approved';
                selectedIds.delete(id);
            });
            updateMetrics();
            renderTable();
            showToast('Selected voters approved.');
        }
    });
}

function rejectSelected() {
    const ids = Array.from(selectedIds);
    if (!ids.length) return;
    Swal.fire({
        title: 'Reject selected voters?',
        input: 'text',
        inputLabel: 'Reason (optional)',
        inputPlaceholder: 'e.g., Duplicate registration',
        showCancelButton: true,
        confirmButtonText: 'Reject',
        confirmButtonColor: '#dc3545'
    }).then(res => {
        if (res.isConfirmed) {
            ids.forEach(id => {
                const v = allVoters.find(x => x.id === id);
                if (v && v.status === 'Pending') v.status = 'Rejected';
                selectedIds.delete(id);
            });
            updateMetrics();
            renderTable();
            showToast('Selected voters rejected.');
        }
    });
}

function showToast(msg) {
    toastBody.textContent = msg;
    toast.show();
}

// Bulk upload via SweetAlert2
function handleBulkUpload() {
    Swal.fire({
        title: 'Bulk Upload Voters',
        text: 'Upload a CSV file with columns: name, unique_id, email, status, registration_date, face_image_url',
        input: 'file',
        inputAttributes: {
            accept: '.csv'
        },
        showCancelButton: true,
        confirmButtonText: 'Process File'
    }).then(async (res) => {
        if (!res.isConfirmed || !res.value) return;
        const file = res.value;
        const text = await file.text();
        // Very simple CSV line count (skip header)
        const rows = text.trim().split(/\r?\n/);
        const created = Math.max(0, rows.length - 1);
        Swal.fire({
            icon: 'success',
            title: 'File uploaded',
            text: `${created} record(s) parsed. Preview not implemented in demo.`
        });
    });
}

// Export CSV (demo)
function exportCsv() {
    const headers = ['id', 'name', 'unique_id', 'email', 'status', 'registration_date'];
    const rows = filtered.map(v => headers.map(h => '"' + String(v[h] ?? '').replace(/"/g, '""') + '"').join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'voters_export.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// Search debounce
function debounce(fn, delay = 300) {
    let t;
    return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Trend Chart
function renderTrendChart() {
    const ctx = document.getElementById('trendChart');
    const labels = Array.from({
        length: 14
    }).map((_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (13 - i));
        return d.toLocaleDateString(undefined, {
            month: 'short',
            day: 'numeric'
        });
    });
    const data = labels.map(() => Math.floor(Math.random() * 10) + 2);
    new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Registrations',
                data,
                fill: false,
                borderColor: 'rgba(97,68,166,1)',
                backgroundColor: 'rgba(97,68,166,0.15)',
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.06)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Event bindings
function bindEvents() {
    document.querySelectorAll('#statusTabs .nav-link').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#statusTabs .nav-link').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.getAttribute('data-status');
            currentPage = 1;
            showLoading(true);
            setTimeout(() => {
                renderTable();
            }, 200);
        });
    });

    searchInput.addEventListener('input', debounce((e) => {
        searchTerm = sanitizeInput(e.target.value || '');
        currentPage = 1;
        renderTable();
    }, 300));

    itemsPerPageSelect.addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value, 10) || 8;
        currentPage = 1;
        renderTable();
    });

    selectAll.addEventListener('change', (e) => {
        const checked = e.target.checked;
        filtered.forEach(v => {
            if (checked) selectedIds.add(v.id);
            else selectedIds.delete(v.id);
        });
        renderTable();
    });

    document.getElementById('votersTable').querySelector('thead').addEventListener('click', onHeaderSort);

    document.getElementById('bulkUploadBtn').addEventListener('click', handleBulkUpload);
    document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
    approveSelectedBtn.addEventListener('click', approveSelected);
    rejectSelectedBtn.addEventListener('click', rejectSelected);

    attachTableEvents();

    detailApproveBtn.addEventListener('click', () => {
        if (detailsVoterId) approveVoter(detailsVoterId);
    });
    detailRejectBtn.addEventListener('click', () => {
        if (detailsVoterId) rejectVoter(detailsVoterId);
    });

    detailsModalEl.addEventListener('hidden.bs.modal', () => {
        detailsVoterId = null;
    });
}

// Init
window.addEventListener('DOMContentLoaded', () => {
    seedData();
    renderTrendChart();
    showLoading(true);
    bindEvents();
    setTimeout(() => {
        renderTable();
    }, 400); // simulate load
});
  </script>
 </body>
</html>
