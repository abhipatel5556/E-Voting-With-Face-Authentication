<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Election Results | FaceID Voting
  </title>
  <!-- Brand Typography: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <!-- Site Theme -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page-specific CSS -->
   <link href="static/voter_results.css" rel="stylesheet"/>
  </link>
 </head>
 <body class="view-grid">
  <!-- Header (Fixed Top) -->
  <style>
   .app-header-voter{background:#6144a6;color:#fff}
    .app-header-voter .navbar-brand,.app-header-voter .nav-link,.app-header-voter .dropdown-toggle{color:#fff}
    .app-header-voter .form-control:focus{box-shadow:none;border-color:#ddd}
    .notif-dot{position:absolute;top:.25rem;right:.25rem;width:.5rem;height:.5rem;background:#dc3545;border-radius:50%}
  </style>
  <nav class="navbar navbar-expand-lg app-header-voter shadow-sm fixed-top">
   <div class="container-fluid">
    <!-- Mobile sidebar toggle uses Offcanvas -->
    <button aria-controls="mobileSidebar" aria-expanded="false" aria-label="Toggle sidebar" class="btn btn-outline-light d-lg-none me-2" data-bs-target="#mobileSidebar" data-bs-toggle="offcanvas" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./voter_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/56/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
     Voter Portal
    </a>
    <button aria-controls="voterNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#voterNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="voterNav">
     <form action="./voter_dashboard.html" class="d-none d-md-flex ms-auto me-3" role="search">
      <div class="input-group input-group-sm">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search elections" class="form-control" name="q" placeholder="Search elections" type="search"/>
      </div>
     </form>
     <ul class="navbar-nav align-items-center">
      <li class="nav-item me-2 d-none d-md-block">
       <a class="btn btn-light btn-sm" href="./voter_dashboard.html#active">
        <i class="fa-solid fa-check-to-slot me-1">
        </i>
        Active Elections
       </a>
      </li>
      <li class="nav-item me-2 position-relative">
       <a aria-label="Notifications" class="nav-link" href="#" id="notifLink">
        <i class="fa-regular fa-bell">
        </i>
        <span class="notif-dot">
        </span>
       </a>
      </li>
      <li class="nav-item dropdown">
       <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="voterProfileMenu" role="button">
        <img alt="Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=40" style="width:28px;height:28px"/>
        <span id="headerUserName">
         John Doe
        </span>
       </a>
       <ul class="dropdown-menu dropdown-menu-end">
        <li>
         <h6 class="dropdown-header">
          Voter
         </h6>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-gear me-2">
          </i>
          Settings
         </a>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-circle-question me-2">
          </i>
          Help
         </a>
        </li>
        <li>
         <hr class="dropdown-divider"/>
        </li>
        <li>
         <a class="dropdown-item" href="#" id="logoutLink">
          <i class="fa-solid fa-right-from-bracket me-2">
          </i>
          Logout
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <!-- Mobile Offcanvas Sidebar -->
  <div aria-labelledby="mobileSidebarLabel" class="offcanvas offcanvas-start" id="mobileSidebar" style="width:260px" tabindex="-1">
   <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileSidebarLabel">
     Menu
    </h5>
    <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
    </button>
   </div>
   <div class="offcanvas-body p-0">
    <div class="p-3 border-bottom d-flex align-items-center">
     <img alt="User Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
     <div>
      <div class="fw-semibold" id="mobileVoterName">
       John Doe
      </div>
      <div class="text-muted small">
       Voter
      </div>
     </div>
    </div>
    <div class="p-3">
     <div class="mb-2 text-uppercase text-muted" style="font-size:.72rem;letter-spacing:.08em;">
      Overview
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html">
        <i class="fa-solid fa-gauge-high fa-fw me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="mb-2 text-uppercase text-muted" style="font-size:.72rem;letter-spacing:.08em;">
      Elections
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html#active">
        <i class="fa-solid fa-check-to-slot fa-fw me-2">
        </i>
        Active Elections
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html#completed">
        <i class="fa-solid fa-square-poll-horizontal fa-fw me-2">
        </i>
        Completed &amp; Results
       </a>
      </li>
     </ul>
     <div class="mb-2 text-uppercase text-muted" style="font-size:.72rem;letter-spacing:.08em;">
      Help
     </div>
     <ul class="nav flex-column">
      <li class="nav-item">
       <a class="nav-link" href="#" onclick="return false;">
        <i class="fa-solid fa-circle-question fa-fw me-2">
        </i>
        How to Vote
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="#" onclick="return false;">
        <i class="fa-solid fa-shield-halved fa-fw me-2">
        </i>
        Privacy
       </a>
      </li>
     </ul>
    </div>
   </div>
  </div>
  <!-- Desktop Sidebar -->
  <style>
   :root { --primary-color:#6144a6; --secondary-color:#ffffff; --hover-bg: rgba(97,68,166,.08); --active-bg: rgba(97,68,166,.14); }
    .app-sidebar-voter{width:260px;background:#fff;border-right:1px solid #eee;min-height:100vh;}
    .app-sidebar-voter .brand{border-bottom:1px solid #eee}
    .app-sidebar-voter .nav-link{color:#444;border-radius:.35rem;padding:.5rem .75rem}
    .app-sidebar-voter .nav-link .fa-fw{width:1.25rem}
    .app-sidebar-voter .nav-link:hover{background:var(--hover-bg)}
    .app-sidebar-voter .nav-link.active{background:var(--active-bg);border-left:4px solid var(--primary-color)}
    .app-sidebar-voter .section-title{font-size:.72rem;letter-spacing:.08em;color:#888}
    @media (max-width: 991.98px){ .app-sidebar-voter{display:none;} }
  </style>
  <aside class="app-sidebar-voter d-none d-lg-block" id="appSidebarVoter">
   <div class="brand d-flex align-items-center p-3">
    <a class="text-decoration-none d-flex align-items-center" href="./voter_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo2/52/26';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:26px"/>
     <span class="fw-semibold text-dark">
      FaceID Voting
     </span>
    </a>
   </div>
   <div class="p-3">
    <div class="d-flex align-items-center mb-3">
     <img alt="User Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
     <div>
      <div class="fw-semibold" id="voterName">
       John Doe
      </div>
      <div class="text-muted small">
       Voter
      </div>
     </div>
    </div>
    <div class="mb-2 section-title text-uppercase">
     Overview
    </div>
    <ul class="nav flex-column mb-3">
     <li class="nav-item">
      <a class="nav-link" href="./voter_dashboard.html">
       <i class="fa-solid fa-gauge-high fa-fw me-2">
       </i>
       Dashboard
      </a>
     </li>
    </ul>
    <div class="mb-2 section-title text-uppercase">
     Elections
    </div>
    <ul class="nav flex-column mb-3">
     <li class="nav-item">
      <a class="nav-link" href="./voter_dashboard.html#active">
       <i class="fa-solid fa-check-to-slot fa-fw me-2">
       </i>
       Active Elections
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link" href="./voter_dashboard.html#completed">
       <i class="fa-solid fa-square-poll-horizontal fa-fw me-2">
       </i>
       Completed &amp; Results
      </a>
     </li>
    </ul>
    <div class="mb-2 section-title text-uppercase">
     Help
    </div>
    <ul class="nav flex-column">
     <li class="nav-item">
      <a class="nav-link" href="#" onclick="return false;">
       <i class="fa-solid fa-circle-question fa-fw me-2">
       </i>
       How to Vote
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link" href="./privacy.html" onclick="return false;">
       <i class="fa-solid fa-shield-halved fa-fw me-2">
       </i>
       Privacy
      </a>
     </li>
    </ul>
   </div>
  </aside>
  <!-- Main Content -->
  <main class="flex-grow-1 main-panel" id="mainContent">
   <div class="container-fluid container-max">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb mt-2">
     <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
       <a href="./voter_dashboard.html">
        <i class="fa-solid fa-house me-1">
        </i>
        Dashboard
       </a>
      </li>
      <li aria-current="page" class="breadcrumb-item active">
       <i class="fa-solid fa-flag-checkered me-1">
       </i>
       Election Results
      </li>
     </ol>
    </nav>
    <!-- Election Header -->
    <section class="mt-3" id="electionHeader">
     <div class="app-card mb-3">
      <div class="card-header">
       <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-square-poll-vertical text-primary">
        </i>
        <h1 class="page-title mb-0" id="electionTitle">
         Loading election title...
        </h1>
       </div>
       <span class="badge-soft info" id="electionStatusBadge">
        Published
       </span>
      </div>
      <div class="card-body">
       <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div class="text-muted" id="electionDescription">
         Final, certified results are displayed below.
        </div>
        <div class="small text-muted" id="electionEndDate">
         Ended on —
        </div>
       </div>
      </div>
     </div>
     <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="fa-solid fa-circle-info me-2">
      </i>
      <div>
       Official results are certified and publicly viewable. For audit details, contact the election administrator.
      </div>
     </div>
    </section>
    <!-- Turnout Summary -->
    <section class="mt-4" id="turnoutSummary">
     <div class="row g-3">
      <div class="col-12 col-lg-5">
       <div class="app-card h-100">
        <div class="card-header">
         <div class="widget-title mb-0">
          Voter Turnout
         </div>
         <span class="text-muted small">
          Final
         </span>
        </div>
        <div class="card-body d-flex align-items-center justify-content-center" style="min-height:260px;">
         <!-- Doughnut Chart -->
         <div class="position-relative" style="width:240px;height:240px;">
          <canvas aria-label="Turnout chart" height="240" id="turnoutChart" role="img" width="240">
          </canvas>
         </div>
        </div>
       </div>
      </div>
      <div class="col-12 col-lg-7">
       <div class="grid auto-fit-md">
        <div class="metric-card">
         <div class="metric-title">
          Votes Cast
         </div>
         <div class="metric-value" id="votesCastValue">
          <span class="skeleton" style="height:32px;">
          </span>
         </div>
         <div class="text-muted">
          All successfully recorded ballots.
         </div>
        </div>
        <div class="metric-card">
         <div class="metric-title">
          Eligible Voters
         </div>
         <div class="metric-value" id="eligibleVotersValue">
          <span class="skeleton" style="height:32px;">
          </span>
         </div>
         <div class="text-muted">
          Total eligible for this election.
         </div>
        </div>
        <div class="metric-card">
         <div class="metric-title">
          Turnout
         </div>
         <div class="metric-value highlight-info" id="turnoutPercentValue">
          <span class="skeleton" style="height:32px;">
          </span>
         </div>
         <div class="text-muted">
          Percentage of eligible who voted.
         </div>
        </div>
       </div>
      </div>
     </div>
    </section>
    <!-- Results Visualization -->
    <section class="mt-4" id="resultsVisualization">
     <div class="app-card mb-3">
      <div class="card-header">
       <div class="widget-title mb-0">
        <i class="fa-solid fa-chart-column me-2 text-primary">
        </i>
        Vote Distribution
       </div>
       <div class="text-muted small" id="totalVotesMeta">
        Total votes: —
       </div>
      </div>
      <div class="card-body">
       <canvas aria-label="Candidate votes bar chart" height="160" id="resultsBarChart" role="img">
       </canvas>
      </div>
     </div>
     <div class="app-card">
      <div class="card-header flex-wrap">
       <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-table-list text-primary">
        </i>
        <div class="widget-title mb-0">
         Detailed Results
        </div>
       </div>
       <div class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm">
         <span class="input-group-text">
          <i class="fa-solid fa-filter">
          </i>
         </span>
         <input class="form-control" id="tableFilterInput" placeholder="Filter candidates" type="text"/>
        </div>
       </div>
      </div>
      <div class="card-body p-0">
       <div class="table-responsive">
        <table aria-describedby="tablePaginationInfo" class="table table-theme mb-0" id="resultsTable">
         <thead>
          <tr>
           <th scope="col">
            Candidate
           </th>
           <th scope="col">
            Affiliation
           </th>
           <th class="sortable" data-key="votes" scope="col">
            Votes
            <i aria-hidden="true" class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable" data-key="percent" scope="col">
            Percent
            <i aria-hidden="true" class="fa-solid fa-sort ms-1">
            </i>
           </th>
          </tr>
         </thead>
         <tbody id="resultsTableBody">
          <!-- Loading skeleton rows -->
          <tr>
           <td class="p-3" colspan="4">
            <span class="skeleton" style="height:20px;">
            </span>
           </td>
          </tr>
          <tr>
           <td class="p-3" colspan="4">
            <span class="skeleton" style="height:20px;">
            </span>
           </td>
          </tr>
          <tr>
           <td class="p-3" colspan="4">
            <span class="skeleton" style="height:20px;">
            </span>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
      <div class="card-footer d-flex flex-wrap align-items-center justify-content-between gap-2">
       <small class="text-muted" id="tablePaginationInfo">
        Showing 0–0 of 0 candidates
       </small>
       <div class="text-muted small">
        Click headers to sort by votes or percent
       </div>
      </div>
     </div>
    </section>
    <!-- Navigation Controls -->
    <section class="mt-4">
     <div class="d-flex align-items-center justify-content-between">
      <a class="btn btn-primary" href="./voter_dashboard.html" id="backToDashboardBtn">
       <i class="fa-solid fa-arrow-left me-2">
       </i>
       Back to Dashboard
      </a>
      <div class="text-muted small">
       Election ID:
       <span id="electionIdText">
        —
       </span>
      </div>
     </div>
    </section>
    <!-- Error State (hidden by default) -->
    <div class="error-state mt-4 d-none" id="errorState">
     <i class="fa-solid fa-triangle-exclamation text-danger" style="font-size:2rem">
     </i>
     <div class="error-state-text">
      Failed to load results. Please try again.
     </div>
     <button class="btn btn-danger retry-button" id="retryLoadBtn">
      <i class="fa-solid fa-rotate me-1">
      </i>
      Retry
     </button>
    </div>
   </div>
  </main>
  <!-- Footer -->
  <style>
   .app-footer-voter{background:#f8f9fa;border-top:1px solid #eee;color:#555}
    .app-footer-voter a{color:#6144a6;text-decoration:none}
    .app-footer-voter a:hover{text-decoration:underline}
  </style>
  <footer class="app-footer-voter py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="mb-2 mb-md-0">
     <a class="btn btn-outline-secondary btn-sm me-2" href="./voter_dashboard.html">
      <i class="fa-solid fa-house me-1">
      </i>
      Dashboard
     </a>
     <a class="btn btn-outline-secondary btn-sm" href="./voter_dashboard.html#completed">
      <i class="fa-solid fa-square-poll-horizontal me-1">
      </i>
      Results
     </a>
    </div>
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo3/36/18';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:18px"/>
     <small class="me-3">
      © 2025 FaceID Voting
     </small>
     <a class="small me-3" href="#" onclick="return false;">
      Terms
     </a>
     <a class="small" href="#" onclick="return false;">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Toast: System feedback -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
   <div aria-atomic="true" aria-live="polite" class="toast align-items-center text-bg-primary border-0" id="loadToast" role="status">
    <div class="d-flex">
     <div class="toast-body">
      <i class="fa-solid fa-circle-check me-2">
      </i>
      Election results loaded successfully.
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- Scripts -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <script>
   // Brand typography override
document.documentElement.style.setProperty('--font-sans', "'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'");

// Mock data fetch for election results
const ELECTION_ID = new URLSearchParams(location.search).get('id') || 'EL-2025-01';
const mockFetchResults = () => new Promise((resolve) => {
    setTimeout(() => {
        const data = {
            id: ELECTION_ID,
            title: '2025 Student Union Presidential Election',
            description: 'Official results for the Student Union presidential race. Votes were recorded with end-to-end verifiability.',
            endDate: '2025-05-03T18:00:00Z',
            stats: {
                eligible: 5000,
                votesCast: 3420
            },
            candidates: [{
                name: 'Alex Johnson',
                party: 'Independent',
                photo: 'https://picsum.photos/seed/c1/64/64',
                votes: 1120
            }, {
                name: 'Brianna Lee',
                party: 'Unity Party',
                photo: 'https://picsum.photos/seed/c2/64/64',
                votes: 980
            }, {
                name: 'Carlos Mendes',
                party: 'Student First',
                photo: 'https://picsum.photos/seed/c3/64/64',
                votes: 610
            }, {
                name: 'Diana Patel',
                party: 'Future Now',
                photo: 'https://picsum.photos/seed/c4/64/64',
                votes: 420
            }, {
                name: 'Evan Smith',
                party: 'Green Campus',
                photo: 'https://picsum.photos/seed/c5/64/64',
                votes: 190
            }, {
                name: 'Fatima Noor',
                party: 'Tech Forward',
                photo: 'https://picsum.photos/seed/c6/64/64',
                votes: 100
            }]
        };
        resolve(data);
    }, 700);
});

// Utilities
const formatNumber = (n) => n.toLocaleString();
const toPercent = (n, d = 1) => `${n.toFixed(d)}%`;
const formatEndDate = (iso) => new Date(iso).toLocaleString(undefined, {
    dateStyle: 'medium',
    timeStyle: 'short'
});

// Charts
let turnoutChartInstance = null;
let barChartInstance = null;

const centerTextPlugin = {
    id: 'centerText',
    afterDatasetsDraw(chart, args, pluginOptions) {
        const {
            ctx,
            chartArea: {
                width,
                height
            }
        } = chart;
        if (!pluginOptions || !pluginOptions.text) return;
        ctx.save();
        ctx.font = '700 28px Poppins, sans-serif';
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(pluginOptions.text, width / 2, height / 2 + chart.getDatasetMeta(0).data[0].y * 0);
    }
};

Chart.register(centerTextPlugin);

function renderTurnoutChart(percentage) {
    const ctx = document.getElementById('turnoutChart');
    if (turnoutChartInstance) turnoutChartInstance.destroy();
    turnoutChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Turnout', 'Non-voters'],
            datasets: [{
                data: [percentage, 100 - percentage],
                backgroundColor: ['#6144a6', '#e6e6f2'],
                borderWidth: 0,
                hoverOffset: 6
            }]
        },
        options: {
            responsive: true,
            cutout: '68%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.label}: ${ctx.raw.toFixed(1)}%`
                    }
                },
                centerText: {
                    text: toPercent(percentage)
                }
            }
        }
    });
}

function renderBarChart(candidates) {
    const ctx = document.getElementById('resultsBarChart');
    const labels = candidates.map(c => c.name);
    const votes = candidates.map(c => c.votes);
    if (barChartInstance) barChartInstance.destroy();
    barChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Votes',
                data: votes,
                backgroundColor: 'rgba(97,68,166,0.85)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2.4,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0,0,0,0.06)'
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${formatNumber(ctx.raw)} votes`
                    }
                }
            }
        }
    });
}

// Table rendering and interactivity
let currentData = null;
let sortState = {
    key: 'votes',
    dir: 'desc'
};

function computePercentages(data) {
    const total = data.stats.votesCast;
    data.candidates = data.candidates.map(c => ({
        ...c,
        percent: (c.votes / total) * 100
    }));
    return data;
}

function markWinner(candidates) {
    const maxVotes = Math.max(...candidates.map(c => c.votes));
    return candidates.map(c => ({
        ...c,
        winner: c.votes === maxVotes
    }));
}

function renderTable(candidates) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    const filter = document.getElementById('tableFilterInput').value.toLowerCase().trim();
    const filtered = candidates.filter(c => c.name.toLowerCase().includes(filter) || (c.party || '').toLowerCase().includes(filter));

    filtered.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <img src="${c.photo}" alt="${c.name} photo" class="rounded" style="width:36px;height:36px;object-fit:cover" onerror="this.onerror=null;this.src='https://picsum.photos/seed/${encodeURIComponent(c.name)}/36/36';">
              <div>
                <div class="fw-semibold">${c.name} ${c.winner ? '<span class="badge bg-success ms-1">Winner</span>' : ''}</div>
                <div class="text-muted small">Candidate</div>
              </div>
            </div>
          </td>
          <td>${c.party || ''}</td>
          <td data-sort-value="${c.votes}">${formatNumber(c.votes)}</td>
          <td data-sort-value="${c.percent}">${toPercent(c.percent)}</td>
        `;
        tbody.appendChild(tr);
    });

    // Pagination info (static demo)
    const info = document.getElementById('tablePaginationInfo');
    info.textContent = `Showing ${filtered.length === 0 ? 0 : 1}–${filtered.length} of ${candidates.length} candidates`;
}

function applySort(candidates) {
    const {
        key,
        dir
    } = sortState;
    const sorted = [...candidates].sort((a, b) => {
        const av = key === 'votes' ? a.votes : a.percent;
        const bv = key === 'votes' ? b.votes : b.percent;
        return dir === 'asc' ? av - bv : bv - av;
    });
    return sorted;
}

function updateSortIcons() {
    document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
        const icon = th.querySelector('i');
        const key = th.getAttribute('data-key');
        if (key === sortState.key) {
            icon.className = `fa-solid ${sortState.dir === 'asc' ? 'fa-sort-up' : 'fa-sort-down'} ms-1`;
        } else {
            icon.className = 'fa-solid fa-sort ms-1';
        }
    });
}

function attachTableEvents() {
    document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-key');
            if (sortState.key === key) {
                sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.dir = 'desc';
            }
            updateSortIcons();
            const sorted = applySort(currentData.candidates);
            renderTable(sorted);
            renderBarChart(sorted);
        });
    });

    document.getElementById('tableFilterInput').addEventListener('input', () => {
        const sorted = applySort(currentData.candidates);
        renderTable(sorted);
    });
}

function showToast() {
    const toastEl = document.getElementById('loadToast');
    const toast = new bootstrap.Toast(toastEl, {
        delay: 2500
    });
    toast.show();
}

function setHeaderSpacing() {
    // Ensure main content sits below fixed header
    const header = document.querySelector('.app-header-voter');
    const main = document.getElementById('mainContent');
    if (header && main) {
        const h = header.offsetHeight;
        main.style.paddingTop = (h + 16) + 'px';
    }
}

// Notifications
document.getElementById('notifLink').addEventListener('click', (e) => {
    e.preventDefault();
    Swal.fire({
        title: 'Notifications',
        html: '<div class="text-start">\
                <div class="mb-2"><i class="fa-solid fa-square-poll-vertical text-primary me-2"></i>Official results published for election <strong>' + ELECTION_ID + '</strong>.</div>\
                <div class="mb-2"><i class="fa-regular fa-circle-check text-success me-2"></i>Your vote was counted.</div>\
              </div>',
        icon: 'info',
        confirmButtonText: 'Close',
        confirmButtonColor: '#6144a6'
    });
});

// Logout flow
document.getElementById('logoutLink').addEventListener('click', (e) => {
    e.preventDefault();
    Swal.fire({
        title: 'Logout?',
        text: 'You will be signed out and redirected to the login page.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Logout',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc3545',
    }).then((res) => {
        if (res.isConfirmed) {
            location.href = './index.html';
        }
    });
});

// Retry button
document.getElementById('retryLoadBtn').addEventListener('click', () => init());

// Init
async function init() {
    setHeaderSpacing();
    document.getElementById('electionIdText').textContent = ELECTION_ID;
    try {
        const data = await mockFetchResults();
        const enriched = markWinner(computePercentages(data)).sort((a, b) => b.votes - a.votes);
        data.candidates = enriched;
        currentData = data;

        // Header
        document.getElementById('electionTitle').textContent = data.title;
        document.getElementById('electionDescription').textContent = data.description;
        document.getElementById('electionEndDate').textContent = 'Ended on ' + formatEndDate(data.endDate);

        // Metrics
        document.getElementById('votesCastValue').textContent = formatNumber(data.stats.votesCast);
        document.getElementById('eligibleVotersValue').textContent = formatNumber(data.stats.eligible);
        const turnout = (data.stats.votesCast / data.stats.eligible) * 100;
        document.getElementById('turnoutPercentValue').textContent = toPercent(turnout, 1);

        // Charts
        renderTurnoutChart(turnout);
        renderBarChart(data.candidates);

        // Table
        attachTableEvents();
        updateSortIcons();
        renderTable(data.candidates);

        // Meta
        document.getElementById('totalVotesMeta').textContent = 'Total votes: ' + formatNumber(data.stats.votesCast);

        // Toast
        showToast();

        // Hide error if visible
        document.getElementById('errorState').classList.add('d-none');
    } catch (err) {
        console.error(err);
        document.getElementById('errorState').classList.remove('d-none');
        Swal.fire({
            title: 'Error',
            text: 'Unable to load results. Please retry.',
            icon: 'error',
            confirmButtonColor: '#6144a6'
        });
    }
}

window.addEventListener('resize', setHeaderSpacing);
document.addEventListener('DOMContentLoaded', init);
  </script>
 </body>
</html>
