<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Election Monitoring | Admin Console
  </title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <!-- Bootstrap 5 -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
   <!-- Global Theme Styles -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page-specific Styles -->
   <link href="static/election_monitoring.css" rel="stylesheet"/>
  </link>
 </head>
 <body>
  <!-- Header (Common Component: needed on this admin monitoring page) -->
  <nav class="navbar navbar-expand-lg app-header-admin shadow-sm">
   <div class="container-fluid">
    <button aria-controls="appSidebarAdmin" aria-expanded="false" aria-label="Toggle sidebar" class="btn btn-outline-light d-lg-none me-2" data-bs-target="#appSidebarAdmin" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./admin_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand/120/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
     Admin Console
    </a>
    <button aria-controls="adminNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#adminNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="adminNav">
     <form action="./elections_list.html" class="d-none d-md-flex ms-auto me-3" role="search">
      <div class="input-group input-group-sm">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search" class="form-control" name="q" placeholder="Search elections or voters" type="search"/>
      </div>
     </form>
     <ul class="navbar-nav align-items-center">
      <li class="nav-item me-2 d-none d-md-block">
       <a class="btn btn-light btn-sm" href="./election_creation.html">
        <i class="fa-solid fa-plus me-1">
        </i>
        Create Election
       </a>
      </li>
      <li class="nav-item me-2 position-relative">
       <a aria-label="Notifications" class="nav-link" href="#">
        <i class="fa-regular fa-bell">
        </i>
        <span class="notif-dot">
        </span>
       </a>
      </li>
      <li class="nav-item dropdown">
       <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="adminProfileMenu" role="button">
        <img alt="Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=40" style="width:28px;height:28px"/>
        <span>
         Alex Smith
        </span>
       </a>
       <ul class="dropdown-menu dropdown-menu-end">
        <li>
         <h6 class="dropdown-header">
          Administrator
         </h6>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-gear me-2">
          </i>
          Settings
         </a>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-book-open-reader me-2">
          </i>
          Admin Guide
         </a>
        </li>
        <li>
         <hr class="dropdown-divider"/>
        </li>
        <li>
         <a class="dropdown-item" href="./index.html">
          <i class="fa-solid fa-right-from-bracket me-2">
          </i>
          Logout
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <div class="d-flex">
   <!-- Sidebar (Common Component: needed on this admin monitoring page) -->
   <aside class="app-sidebar-admin d-none d-lg-block" id="appSidebarAdmin">
    <div class="brand d-flex align-items-center p-3">
     <a class="text-decoration-none d-flex align-items-center" href="./admin_dashboard.html">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand2/120/26';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:26px"/>
      <span class="fw-semibold text-dark">
       Admin Console
      </span>
     </a>
    </div>
    <div class="p-3">
     <div class="d-flex align-items-center mb-3">
      <img alt="Admin Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
      <div>
       <div class="fw-semibold" id="adminName">
        Alex Smith
       </div>
       <div class="text-muted small">
        Administrator
       </div>
      </div>
     </div>
     <div class="mb-2 section-title text-uppercase">
      Overview
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./admin_dashboard.html">
        <i class="fa-solid fa-gauge-high fa-fw me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Elections
     </div>
     <ul class="nav flex-column mb-1">
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html">
        <i class="fa-solid fa-list-check fa-fw me-2">
        </i>
        All Elections
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./election_creation.html">
        <i class="fa-solid fa-plus fa-fw me-2">
        </i>
        Create New
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link active" href="./elections_list.html?status=active">
        <i class="fa-solid fa-signal fa-fw me-2">
        </i>
        Active &amp; Monitoring
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./admin_results.html">
        <i class="fa-solid fa-chart-column fa-fw me-2">
        </i>
        Completed &amp; Results
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase mt-3">
      Voters
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html">
        <i class="fa-solid fa-users fa-fw me-2">
        </i>
        Manage Voters
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html?status=pending">
        <i class="fa-solid fa-user-check fa-fw me-2">
        </i>
        Pending Approvals
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Resources
     </div>
     <ul class="nav flex-column">
      <li class="nav-item">
       <a class="nav-link" href="./admin_guide.html" onclick="return false;">
        <i class="fa-solid fa-book-open-reader fa-fw me-2">
        </i>
        Admin Guide
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./privacy.html">
        <i class="fa-solid fa-shield-halved fa-fw me-2">
        </i>
        Privacy
       </a>
      </li>
     </ul>
    </div>
   </aside>
   <!-- Main Content -->
   <main class="flex-grow-1">
    <div class="container-fluid py-3 py-lg-4">
     <!-- Breadcrumb -->
     <nav aria-label="breadcrumb" class="breadcrumb mb-2">
      <span class="breadcrumb-item">
       <a href="./admin_dashboard.html">
        Admin
       </a>
      </span>
      <span class="breadcrumb-item">
       <a href="./elections_list.html">
        Elections
       </a>
      </span>
      <span aria-current="page" class="breadcrumb-item active">
       Monitoring
      </span>
     </nav>
     <!-- System info alert -->
     <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="fa-solid fa-circle-info me-2">
      </i>
      <div>
       Monitoring live election data. Auto-refresh every
       <strong>
        30 seconds
       </strong>
       . Voter anonymity is preserved; only aggregated metrics are shown.
      </div>
     </div>
     <!-- Election Monitoring Header -->
     <section class="page-header align-items-center">
      <div class="d-flex align-items-center gap-3 flex-wrap">
       <div>
        <h1 class="page-title mb-1" id="electionTitle">
         Election Title
        </h1>
        <div>
         <span class="badge-soft success" id="electionStatusBadge">
          Active
         </span>
         <small class="text-muted ms-2" id="electionIdDisplay">
         </small>
        </div>
       </div>
      </div>
      <div class="navigation-controls d-flex gap-2 flex-wrap">
       <button class="btn btn-light" id="toggleRefreshBtn" type="button">
        <i class="fa-solid fa-pause me-1">
        </i>
        <span>
         Pause Auto-Refresh
        </span>
       </button>
       <button class="btn btn-outline-primary" id="exportCSVBtn" type="button">
        <i class="fa-solid fa-file-arrow-down me-1">
        </i>
        Export CSV
       </button>
       <a class="btn btn-secondary" href="./elections_list.html">
        <i class="fa-solid fa-arrow-left me-1">
        </i>
        Back to Elections
       </a>
      </div>
     </section>
     <!-- Key Metrics Dashboard -->
     <section class="grid auto-fit-lg mb-4" id="keyMetrics">
      <!-- Voter Turnout Card -->
      <div class="metric-card">
       <div class="d-flex justify-content-between align-items-center">
        <div class="metric-title">
         Voter Turnout
        </div>
        <i class="fa-solid fa-person-booth text-primary">
        </i>
       </div>
       <div class="metric-value" id="turnoutCount">
        <span class="skeleton" style="height:34px;width:220px;display:inline-block">
        </span>
       </div>
       <div class="text-muted">
        Votes cast / Eligible voters
       </div>
      </div>
      <!-- Time Remaining Card -->
      <div class="metric-card">
       <div class="d-flex justify-content-between align-items-center">
        <div class="metric-title">
         Time Remaining
        </div>
        <i class="fa-regular fa-clock text-primary">
        </i>
       </div>
       <div class="metric-value" id="timeRemaining">
        <span class="skeleton" style="height:34px;width:180px;display:inline-block">
        </span>
       </div>
       <div class="text-muted">
        Until polls close
       </div>
      </div>
      <!-- Active Stations Card (optional 3rd metric for context) -->
      <div class="metric-card">
       <div class="d-flex justify-content-between align-items-center">
        <div class="metric-title">
         Active Polling Stations
        </div>
        <i class="fa-solid fa-signal text-primary">
        </i>
       </div>
       <div class="metric-value" id="activeStations">
        --
       </div>
       <div class="text-muted">
        Operational status
       </div>
      </div>
     </section>
     <!-- Turnout Visualization -->
     <section class="card mb-4">
      <div class="card-header">
       <div class="title">
        Turnout Progress
       </div>
       <div class="text-muted small">
        Auto-updating
       </div>
      </div>
      <div class="card-body">
       <div class="progress position-relative turnout-progress">
        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress-bar" id="turnoutProgressBar" role="progressbar" style="width: 0%">
        </div>
        <div class="turnout-label" id="turnoutPercentLabel">
         0%
        </div>
       </div>
      </div>
     </section>
     <!-- Turnout Over Time Chart -->
     <section class="card mb-4">
      <div class="card-header">
       <div class="title">
        Turnout Over Time
       </div>
       <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-light" id="resetZoomBtn">
         <i class="fa-solid fa-up-right-and-down-left-from-center me-1">
         </i>
         Reset Zoom
        </button>
       </div>
      </div>
      <div class="card-body">
       <canvas height="120" id="turnoutChart">
       </canvas>
      </div>
     </section>
     <!-- Polling Stations Table -->
     <section class="card mb-4">
      <div class="card-header">
       <div class="title">
        Polling Stations Summary
       </div>
       <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="input-group input-group-sm" style="max-width:260px">
         <span class="input-group-text">
          <i class="fa-solid fa-filter">
          </i>
         </span>
         <input class="form-control" id="stationFilter" placeholder="Filter by station name" type="text"/>
        </div>
        <div class="form-check form-switch ms-2">
         <input class="form-check-input" id="showOnlyOpenSwitch" role="switch" type="checkbox"/>
         <label class="form-check-label small" for="showOnlyOpenSwitch">
          Show only Open
         </label>
        </div>
       </div>
      </div>
      <div class="card-body p-0">
       <div class="table-responsive">
        <table class="table table-theme mb-0" id="stationsTable">
         <thead>
          <tr>
           <th class="sortable" data-sort="name">
            Station
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable" data-sort="status">
            Status
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable text-end" data-sort="votes">
            Votes Cast
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="sortable text-end" data-sort="turnout">
            Turnout %
            <i class="fa-solid fa-sort ms-1">
            </i>
           </th>
           <th class="text-end">
            Actions
           </th>
          </tr>
         </thead>
         <tbody id="stationsBody">
          <!-- Rows injected by JS -->
         </tbody>
        </table>
       </div>
      </div>
      <div class="card-footer d-flex align-items-center justify-content-between">
       <small class="text-muted" id="paginationInfo">
        Showing 1–6 of 24
       </small>
       <div>
        <button class="btn btn-sm btn-light me-1" disabled="" id="prevPageBtn">
         <i class="fa-solid fa-chevron-left">
         </i>
        </button>
        <button class="btn btn-sm btn-light" id="nextPageBtn">
         <i class="fa-solid fa-chevron-right">
         </i>
        </button>
       </div>
      </div>
     </section>
     <!-- Toast container for feedback -->
     <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
      <div aria-atomic="true" aria-live="assertive" class="toast align-items-center text-bg-primary border-0" id="updateToast" role="alert">
       <div class="d-flex">
        <div class="toast-body">
         <i class="fa-solid fa-rotate me-1">
         </i>
         Metrics updated.
        </div>
        <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
        </button>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Footer (Common Component: needed on this page) -->
  <footer class="app-footer-admin py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="mb-2 mb-md-0">
     <a class="btn btn-outline-secondary btn-sm me-2" href="./election_creation.html">
      <i class="fa-solid fa-plus me-1">
      </i>
      Create Election
     </a>
     <a class="btn btn-outline-secondary btn-sm" href="./voter_management.html">
      <i class="fa-solid fa-users me-1">
      </i>
      Manage Voters
     </a>
    </div>
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand3/120/18';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:18px"/>
     <small class="me-3">
      © 2025 FaceID Voting
     </small>
     <a class="small me-3" href="./terms.html">
      Terms
     </a>
     <a class="small" href="./privacy.html">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js">
  </script>
  <script>
   // Brand font on body
document.body.style.fontFamily = 'Poppins, var(--font-sans)';

// Utilities
const $ = (sel, ctx = document) => ctx.querySelector(sel);
const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

// Parse election ID from URL (e.g., ?id=EL-2025-01)
const params = new URLSearchParams(window.location.search);
const electionId = params.get('id') || 'EL-2025-01';
$('#electionIdDisplay').textContent = `Election ID: ${electionId}`;

// State
let autoRefresh = true;
let metricsTimer = null;
let countdownTimer = null;
let chart; // Chart.js instance
let currentStats = {
    votesCast: 0,
    eligibleVoters: 0,
    activeStations: 0
};

// Mock API endpoints (replace with real endpoints)
function fetchElectionDetails(id) {
    // Simulating API delay
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve({
                title: '2025 City Council Elections',
                status: 'Active',
                endTime: new Date(Date.now() + 1000 * 60 * 60 * 5 + 1000 * 60 * 12).toISOString(), // ~5h 12m
            });
        }, 400);
    });
}

function fetchElectionStats(id) {
    return new Promise((resolve, reject) => {
        // Randomly simulate an occasional failure
        const fail = Math.random() < 0.05;
        setTimeout(() => {
            if (fail) return reject(new Error('Network error'));
            // Simulated data evolution
            currentStats.eligibleVoters = 5000;
            const increment = Math.floor(Math.random() * 40) + 20;
            currentStats.votesCast = Math.min(currentStats.votesCast + increment, currentStats.eligibleVoters);
            currentStats.activeStations = 18 + Math.floor(Math.random() * 3); // 18-20
            resolve({
                ...currentStats
            });
        }, 500);
    });
}

// Format helpers
const nf = new Intl.NumberFormat('en-US');

function formatCountdown(ms) {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const pad = (n) => n.toString().padStart(2, '0');
    return `${pad(days)}:${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

// UI updates
function updateMetricsUI(stats) {
    $('#turnoutCount').textContent = `${nf.format(stats.votesCast)} / ${nf.format(stats.eligibleVoters)}`;
    $('#activeStations').textContent = nf.format(stats.activeStations);
    const pct = stats.eligibleVoters > 0 ? (stats.votesCast / stats.eligibleVoters) * 100 : 0;
    const pctClamped = Math.min(100, Math.max(0, pct));
    const pctText = `${pctClamped.toFixed(1)}%`;
    const bar = $('#turnoutProgressBar');
    bar.style.width = pctClamped + '%';
    bar.setAttribute('aria-valuenow', pctClamped.toFixed(1));
    $('#turnoutPercentLabel').textContent = pctText;
}

function startCountdown(endISO) {
    const end = new Date(endISO).getTime();
    if (countdownTimer) clearInterval(countdownTimer);

    function tick() {
        const now = Date.now();
        const remaining = end - now;
        $('#timeRemaining').textContent = formatCountdown(remaining);
        if (remaining <= 0) {
            clearInterval(countdownTimer);
            $('#electionStatusBadge').className = 'badge-soft warning';
            $('#electionStatusBadge').textContent = 'Closed';
        }
    }
    tick();
    countdownTimer = setInterval(tick, 1000);
}

// Toast
const toastEl = $('#updateToast');
const toast = toastEl ? new bootstrap.Toast(toastEl) : null;

// Chart.js setup
function initChart() {
    const ctx = document.getElementById('turnoutChart');
    if (!ctx) return;
    const data = {
        labels: [],
        datasets: [{
            label: 'Votes Cast',
            data: [],
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#6144a6',
            backgroundColor: 'rgba(97,68,166,0.1)',
            tension: 0.2,
            pointRadius: 0,
            fill: true,
        }, ],
    };
    chart = new Chart(ctx, {
        type: 'line',
        data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x'
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Votes'
                    }
                },
            },
        },
    });
}

function appendChartPoint(votes) {
    if (!chart) return;
    const now = new Date();
    const label = now.toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(votes);
    // Limit points to last 50 for performance
    if (chart.data.labels.length > 50) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update('none');
}

$('#resetZoomBtn')?.addEventListener('click', () => {
    try {
        chart?.resetZoom();
    } catch (e) {}
});

// Auto refresh toggle
$('#toggleRefreshBtn')?.addEventListener('click', () => {
    autoRefresh = !autoRefresh;
    const icon = $('#toggleRefreshBtn i');
    const label = $('#toggleRefreshBtn span');
    if (autoRefresh) {
        icon.className = 'fa-solid fa-pause me-1';
        label.textContent = 'Pause Auto-Refresh';
        scheduleMetrics();
    } else {
        icon.className = 'fa-solid fa-play me-1';
        label.textContent = 'Resume Auto-Refresh';
        if (metricsTimer) clearInterval(metricsTimer);
    }
});

// Export CSV (mock)
$('#exportCSVBtn')?.addEventListener('click', () => {
    Swal.fire({
        icon: 'success',
        title: 'Export Started',
        text: 'Your CSV export is being prepared. You will be notified when it is ready.',
        confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#6144a6',
    });
});

// Stations table: mock dataset, pagination, sorting, filtering
const stations = Array.from({
    length: 24
}).map((_, i) => ({
    name: `Station ${String.fromCharCode(65 + (i % 6))}-${(i % 12) + 1}`,
    status: Math.random() > 0.1 ? 'Open' : 'Closed',
    votes: Math.floor(Math.random() * 260) + 40,
    turnout: +(Math.random() * 60 + 10).toFixed(1),
}));
let page = 1;
const pageSize = 6;
let sortKey = 'name';
let sortDir = 'asc';

function renderStations() {
    const filterText = $('#stationFilter').value.toLowerCase();
    const onlyOpen = $('#showOnlyOpenSwitch').checked;
    let filtered = stations.filter(s => s.name.toLowerCase().includes(filterText));
    if (onlyOpen) filtered = filtered.filter(s => s.status === 'Open');
    filtered.sort((a, b) => {
        const v1 = a[sortKey];
        const v2 = b[sortKey];
        if (typeof v1 === 'number') return sortDir === 'asc' ? v1 - v2 : v2 - v1;
        return sortDir === 'asc' ? String(v1).localeCompare(String(v2)) : String(v2).localeCompare(String(v1));
    });
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    page = Math.min(page, totalPages);
    const start = (page - 1) * pageSize;
    const rows = filtered.slice(start, start + pageSize);
    const tbody = $('#stationsBody');
    tbody.innerHTML = '';
    for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td><span class="badge-soft ${r.status === 'Open' ? 'success' : 'warning'}">${r.status}</span></td>
          <td class="text-end">${nf.format(r.votes)}</td>
          <td class="text-end">${r.turnout.toFixed(1)}%</td>
          <td class="text-end">
            <button class="btn btn-sm btn-light"><i class="fa-regular fa-eye me-1"></i>View</button>
          </td>
        `;
        tbody.appendChild(tr);
    }
    $('#paginationInfo').textContent = `Showing ${total === 0 ? 0 : start + 1}${Math.min(start + pageSize, total)} of ${total}`.replace('\u0013', '–');
    $('#prevPageBtn').disabled = page <= 1;
    $('#nextPageBtn').disabled = page >= totalPages;
}

$('#prevPageBtn')?.addEventListener('click', () => {
    if (page > 1) {
        page--;
        renderStations();
    }
});
$('#nextPageBtn')?.addEventListener('click', () => {
    page++;
    renderStations();
});
$('#stationFilter')?.addEventListener('input', () => {
    page = 1;
    renderStations();
});
$('#showOnlyOpenSwitch')?.addEventListener('change', () => {
    page = 1;
    renderStations();
});

$$('.sortable').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort');
        if (sortKey === key) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
            sortKey = key;
            sortDir = 'asc';
        }
        renderStations();
        // Update sort icons
        $$('.sortable i').forEach(i => i.className = 'fa-solid fa-sort ms-1');
        const icon = th.querySelector('i');
        icon.className = sortDir === 'asc' ? 'fa-solid fa-sort-up ms-1' : 'fa-solid fa-sort-down ms-1';
    });
});

// Scheduling and refresh
function scheduleMetrics() {
    if (metricsTimer) clearInterval(metricsTimer);
    metricsTimer = setInterval(async () => {
        if (!autoRefresh) return;
        try {
            const stats = await fetchElectionStats(electionId);
            updateMetricsUI(stats);
            appendChartPoint(stats.votesCast);
            toast?.show();
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Update Failed',
                text: 'Could not refresh metrics. Retrying on next interval.'
            });
        }
    }, 30000); // 30 seconds
}

// Initial load
async function init() {
    try {
        initChart();
        const details = await fetchElectionDetails(electionId);
        $('#electionTitle').textContent = details.title;
        $('#electionStatusBadge').textContent = details.status;
        $('#electionStatusBadge').className = 'badge-soft ' + (details.status.toLowerCase() === 'active' ? 'success' : 'warning');
        startCountdown(details.endTime);
        // First stats update immediately
        const stats = await fetchElectionStats(electionId);
        updateMetricsUI(stats);
        appendChartPoint(stats.votesCast);
        renderStations();
        scheduleMetrics();
    } catch (err) {
        Swal.fire({
            icon: 'error',
            title: 'Failed to load',
            text: 'Unable to load election details at this time.'
        });
    }
}

document.addEventListener('DOMContentLoaded', init);
  </script>
 </body>
</html>
