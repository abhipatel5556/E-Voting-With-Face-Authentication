<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Voter Dashboard • FaceID Voting
  </title>
  <!-- Brand typography: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <!-- Global site theme -->
   <link href="static/style.css" rel="stylesheet">
    <!-- Page-specific CSS -->
    <link href="static/voter_dashboard.css" rel="stylesheet"/>
   </link>
  </link>
 </head>
 <body class="d-flex flex-column min-vh-100">
  <!-- Header (Common Component) -->
  <nav class="navbar navbar-expand-lg app-header-voter shadow-sm position-sticky top-0 z-3">
   <div class="container-fluid">
    <button aria-controls="appSidebarVoter" aria-expanded="false" aria-label="Toggle sidebar" class="btn btn-outline-light d-lg-none me-2" data-bs-target="#appSidebarVoter" data-bs-toggle="collapse" id="toggleSidebarBtn" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./voter_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brandlogo/56/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
     Voter Portal
    </a>
    <button aria-controls="voterNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#voterNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="voterNav">
     <form action="./voter_dashboard.html" class="d-none d-md-flex ms-auto me-3" role="search">
      <div class="input-group input-group-sm">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search elections" class="form-control" name="q" placeholder="Search elections" type="search"/>
      </div>
     </form>
     <ul class="navbar-nav align-items-center">
      <li class="nav-item me-2 d-none d-md-block">
       <a class="btn btn-light btn-sm" href="./voter_dashboard.html#active">
        <i class="fa-solid fa-check-to-slot me-1">
        </i>
        Active Elections
       </a>
      </li>
      <li class="nav-item me-2 position-relative">
       <a aria-label="Notifications" class="nav-link" data-bs-toggle="tooltip" href="#" title="Notifications">
        <i class="fa-regular fa-bell">
        </i>
        <span class="notif-dot">
        </span>
       </a>
      </li>
      <li class="nav-item dropdown">
       <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="voterProfileMenu" role="button">
        <img alt="Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=40" style="width:28px;height:28px"/>
        <span id="headerUserName">
         John Doe
        </span>
       </a>
       <ul class="dropdown-menu dropdown-menu-end">
        <li>
         <h6 class="dropdown-header">
          Voter
         </h6>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-gear me-2">
          </i>
          Settings
         </a>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-circle-question me-2">
          </i>
          Help
         </a>
        </li>
        <li>
         <hr class="dropdown-divider"/>
        </li>
        <li>
         <a class="dropdown-item" href="#" id="logoutBtn">
          <i class="fa-solid fa-right-from-bracket me-2">
          </i>
          Logout
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <!-- Content area: Sidebar + Main -->
  <div class="flex-grow-1 d-flex">
   <!-- Sidebar (Common Component) -->
   <aside class="app-sidebar-voter collapse d-lg-block" id="appSidebarVoter">
    <div class="brand d-flex align-items-center p-3">
     <a class="text-decoration-none d-flex align-items-center" href="./voter_dashboard.html">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/sidebarlogo/52/26';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:26px"/>
      <span class="fw-semibold text-dark">
       FaceID Voting
      </span>
     </a>
    </div>
    <div class="p-3">
     <div class="d-flex align-items-center mb-3">
      <img alt="User Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
      <div>
       <div class="fw-semibold" id="voterName">
        John Doe
       </div>
       <div class="text-muted small">
        Voter
       </div>
      </div>
     </div>
     <div class="mb-2 section-title text-uppercase">
      Overview
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link active" href="./voter_dashboard.html">
        <i class="fa-solid fa-gauge-high fa-fw me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Elections
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html#active">
        <i class="fa-solid fa-check-to-slot fa-fw me-2">
        </i>
        Active Elections
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html#completed">
        <i class="fa-solid fa-square-poll-horizontal fa-fw me-2">
        </i>
        Completed &amp; Results
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Help
     </div>
     <ul class="nav flex-column">
      <li class="nav-item">
       <a class="nav-link" href="#" onclick="return false;">
        <i class="fa-solid fa-circle-question fa-fw me-2">
        </i>
        How to Vote
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_dashboard.html#privacy">
        <i class="fa-solid fa-shield-halved fa-fw me-2">
        </i>
        Privacy
       </a>
      </li>
     </ul>
    </div>
   </aside>
   <!-- Main content -->
   <main class="main-panel container-fluid" id="mainContent">
    <div class="container-max">
     <!-- Page header -->
     <div class="page-header">
      <div class="d-flex align-items-center gap-2">
       <h1 class="page-title mb-0">
        Voter Dashboard
       </h1>
       <span class="badge-soft primary">
        <i class="fa-regular fa-id-badge">
        </i>
        Authenticated
       </span>
      </div>
      <div class="d-flex align-items-center gap-2">
       <button class="btn btn-light btn-sm" id="refreshBtn">
        <i class="fa-solid fa-rotate me-1">
        </i>
        Refresh
       </button>
       <a class="btn btn-primary btn-sm" href="./voter_dashboard.html#active">
        <i class="fa-solid fa-check-to-slot me-1">
        </i>
        Go to Active
       </a>
      </div>
     </div>
     <!-- System feedback area -->
     <div class="mb-3" id="systemAlerts">
     </div>
     <div class="row g-3 align-items-stretch">
      <!-- Left: Elections tabs and lists -->
      <div class="col-12 col-lg-8">
       <!-- Tabs Navigator -->
       <ul class="nav nav-tabs" id="electionTabs" role="tablist">
        <li class="nav-item" role="presentation">
         <button aria-controls="active" aria-selected="true" class="nav-link active" data-bs-target="#active" data-bs-toggle="tab" id="active-tab" role="tab" type="button">
          <i class="fa-solid fa-bolt me-1">
          </i>
          Active
         </button>
        </li>
        <li class="nav-item" role="presentation">
         <button aria-controls="completed" aria-selected="false" class="nav-link" data-bs-target="#completed" data-bs-toggle="tab" id="completed-tab" role="tab" type="button">
          <i class="fa-solid fa-list-check me-1">
          </i>
          Completed
         </button>
        </li>
       </ul>
       <!-- Filters & Search -->
       <div class="card border-top-0 rounded-top-0">
        <div class="card-body py-3">
         <div class="row g-2 align-items-center">
          <div class="col-12 col-md-6">
           <div class="input-group input-group-sm">
            <span class="input-group-text">
             <i class="fa-solid fa-magnifying-glass">
             </i>
            </span>
            <input class="form-control" id="searchInput" placeholder="Search by title or description..." type="text">
            </input>
           </div>
          </div>
          <div class="col-6 col-md-3">
           <select aria-label="Sort by" class="form-select form-select-sm" id="sortSelect">
            <option value="endSoon">
             Sort: Ending Soon
            </option>
            <option value="endLatest">
             Sort: Ending Latest
            </option>
            <option value="alpha">
             Sort: A → Z
            </option>
           </select>
          </div>
          <div class="col-6 col-md-3 text-end">
           <div aria-label="View switcher" class="view-switcher" role="group">
            <div class="option active" id="viewCards">
             <i class="fa-solid fa-grip">
             </i>
            </div>
            <div class="option" id="viewTable">
             <i class="fa-solid fa-table">
             </i>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="tab-content" id="electionTabsContent">
        <!-- Active Tab Pane -->
        <div aria-labelledby="active-tab" class="tab-pane fade show active" id="active" role="tabpanel" tabindex="0">
         <!-- Loading state -->
         <div class="loading-state mt-3 d-none" id="activeLoading">
          <div class="skeleton" style="height:24px;width:40%;">
          </div>
          <div class="skeleton" style="height:150px;">
          </div>
          <div class="skeleton" style="height:150px;">
          </div>
         </div>
         <div class="alert alert-danger d-none mt-3" id="activeError" role="alert">
          <i class="fa-solid fa-circle-exclamation me-1">
          </i>
          Unable to load active elections. Please try again.
         </div>
         <div class="mt-3" id="activeContainer">
          <!-- Cards grid -->
          <div class="card-grid" id="activeGrid">
          </div>
          <!-- Table view (hidden by default) -->
          <div class="d-none mt-3" id="activeTableWrap">
           <div class="table-responsive">
            <table class="table table-theme align-middle" id="activeTable">
             <thead>
              <tr>
               <th>
                Election
               </th>
               <th>
                Ends
               </th>
               <th>
                Status
               </th>
               <th>
                Action
               </th>
              </tr>
             </thead>
             <tbody>
             </tbody>
            </table>
           </div>
           <div class="d-flex justify-content-between small text-muted">
            <div id="activeTableInfo">
             Showing 0 of 0
            </div>
            <div>
             Sorted by
             <span id="activeSortLabel">
              Ending Soon
             </span>
            </div>
           </div>
          </div>
         </div>
        </div>
        <!-- Completed Tab Pane -->
        <div aria-labelledby="completed-tab" class="tab-pane fade" id="completed" role="tabpanel" tabindex="0">
         <!-- Loading state -->
         <div class="loading-state mt-3 d-none" id="completedLoading">
          <div class="skeleton" style="height:24px;width:40%;">
          </div>
          <div class="skeleton" style="height:150px;">
          </div>
          <div class="skeleton" style="height:150px;">
          </div>
         </div>
         <div class="alert alert-danger d-none mt-3" id="completedError" role="alert">
          <i class="fa-solid fa-circle-exclamation me-1">
          </i>
          Unable to load completed elections. Please try again.
         </div>
         <div class="mt-3" id="completedContainer">
          <!-- Cards grid -->
          <div class="card-grid" id="completedGrid">
          </div>
          <!-- Your Activity Table -->
          <div class="card mt-3">
           <div class="card-header">
            <div class="title d-flex align-items-center gap-2">
             <i class="fa-solid fa-clipboard-check">
             </i>
             Your Voting Activity
            </div>
            <div class="d-flex align-items-center gap-2">
             <div class="input-group input-group-sm" style="width:220px;">
              <span class="input-group-text">
               <i class="fa-solid fa-filter">
               </i>
              </span>
              <input class="form-control" id="historyFilter" placeholder="Filter by title..." type="text"/>
             </div>
            </div>
           </div>
           <div class="card-body p-0">
            <div class="table-responsive">
             <table class="table table-theme mb-0" id="historyTable">
              <thead>
               <tr>
                <th class="sortable" data-key="title">
                 Election
                 <i class="fa-solid fa-sort ms-1 text-muted">
                 </i>
                </th>
                <th class="sortable" data-key="castDate">
                 Date Cast
                 <i class="fa-solid fa-sort ms-1 text-muted">
                 </i>
                </th>
                <th>
                 Status
                </th>
                <th>
                 Results
                </th>
               </tr>
              </thead>
              <tbody>
              </tbody>
             </table>
            </div>
           </div>
           <div class="card-footer d-flex justify-content-between small text-muted">
            <div id="historyInfo">
             Showing 1 to 6 of 6
            </div>
            <div>
             Sorted by
             <span id="historySortLabel">
              Election
             </span>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      <!-- Right: At-a-glance metrics / chart -->
      <div class="col-12 col-lg-4">
       <div class="metric-card mb-3">
        <div class="d-flex align-items-center justify-content-between">
         <div>
          <div class="metric-title">
           Eligible Active Elections
          </div>
          <div class="metric-value" id="eligibleCount">
           0
          </div>
         </div>
         <div class="badge-soft info">
          <i class="fa-solid fa-circle-info">
          </i>
          Live
         </div>
        </div>
        <div class="small text-muted">
         Elections you can vote in right now.
        </div>
       </div>
       <div class="card">
        <div class="card-header">
         <div class="title d-flex align-items-center gap-2">
          <i class="fa-solid fa-chart-column">
          </i>
          Participation Overview
         </div>
         <div class="text-muted small">
          Last 6 elections
         </div>
        </div>
        <div class="card-body">
         <canvas aria-label="Participation trend" height="180" id="participationChart" role="img">
         </canvas>
         <div class="d-flex justify-content-between small text-muted mt-2">
          <span>
           <i class="fa-solid fa-circle text-success me-1">
           </i>
           Voted
          </span>
          <span>
           <i class="fa-solid fa-circle text-warning me-1">
           </i>
           Missed
          </span>
         </div>
        </div>
       </div>
       <div class="alert alert-info mt-3" role="alert">
        <i class="fa-regular fa-lightbulb me-2">
        </i>
        Pro tip: You can preview ballots before voting. Click an election card to learn more.
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Footer (Common Component) -->
  <footer class="app-footer-voter py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="mb-2 mb-md-0">
     <a class="btn btn-outline-secondary btn-sm me-2" href="./voter_dashboard.html">
      <i class="fa-solid fa-house me-1">
      </i>
      Dashboard
     </a>
     <a class="btn btn-outline-secondary btn-sm" href="./voter_dashboard.html#completed">
      <i class="fa-solid fa-square-poll-horizontal me-1">
      </i>
      Results
     </a>
    </div>
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/footerlogo/36/18';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:18px"/>
     <small class="me-3">
      © 2025 FaceID Voting
     </small>
     <a class="small me-3" href="./voter_dashboard.html#terms">
      Terms
     </a>
     <a class="small" href="./voter_dashboard.html#privacy">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Toasts container for system messages -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
   <div aria-atomic="true" aria-live="polite" class="toast align-items-center text-bg-primary border-0" id="liveToast" role="status">
    <div class="d-flex">
     <div class="toast-body">
      <i class="fa-solid fa-circle-info me-2">
      </i>
      <span id="toastMsg">
       Action completed
      </span>
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js">
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <!-- Bootstrap Bundle JS -->
  <script crossorigin="anonymous" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
  </script>
  <script>
   // Sample mock data
const activeElections = [{
    id: 'sch-board-2025',
    title: 'School Board Elections 2025',
    description: 'Vote for representatives to the local school board.',
    endDate: '2025-09-30T17:00:00Z',
    hasVoted: false
}, {
    id: 'city-council-w2',
    title: 'City Council Ward 2 Runoff',
    description: 'Runoff between top two candidates in Ward 2.',
    endDate: '2025-10-05T20:00:00Z',
    hasVoted: true
}, {
    id: 'pta-committee',
    title: 'PTA Committee Selection',
    description: 'Parent-Teacher Association committee vote.',
    endDate: '2025-09-14T18:00:00Z',
    hasVoted: false
}, {
    id: 'park-bond',
    title: 'City Park Bond Referendum',
    description: 'Approve funding for new parks and maintenance.',
    endDate: '2025-12-01T23:59:00Z',
    hasVoted: false
}, {
    id: 'union-rep',
    title: 'Union Representative Vote',
    description: 'Select your next union representative.',
    endDate: '2025-09-21T23:00:00Z',
    hasVoted: true
}, {
    id: 'library-trustees',
    title: 'Library Board of Trustees',
    description: 'Elect members to oversee the public library.',
    endDate: '2025-11-04T23:59:00Z',
    hasVoted: false
}];

const completedElections = [{
    id: 'mayor-2024',
    title: 'Mayor Election 2024',
    endDate: '2024-11-10T20:00:00Z',
    resultsPublished: true
}, {
    id: 'school-bond-2024',
    title: 'School Infrastructure Bond',
    endDate: '2024-10-05T20:00:00Z',
    resultsPublished: true
}, {
    id: 'park-levy-2024',
    title: 'Park Maintenance Levy',
    endDate: '2024-08-23T20:00:00Z',
    resultsPublished: false
}, {
    id: 'city-council-ward1',
    title: 'City Council Ward 1',
    endDate: '2024-07-18T20:00:00Z',
    resultsPublished: true
}, {
    id: 'water-authority',
    title: 'Regional Water Authority Seat',
    endDate: '2024-05-06T20:00:00Z',
    resultsPublished: true
}, {
    id: 'school-board-2024',
    title: 'School Board Elections 2024',
    endDate: '2024-04-10T20:00:00Z',
    resultsPublished: true
}];

const votingHistory = [{
    title: 'Mayor Election 2024',
    castDate: '2024-11-10',
    status: 'Counted',
    results: 'Published'
}, {
    title: 'School Infrastructure Bond',
    castDate: '2024-10-05',
    status: 'Counted',
    results: 'Published'
}, {
    title: 'Park Maintenance Levy',
    castDate: '—',
    status: 'Did not vote',
    results: 'Pending'
}, {
    title: 'City Council Ward 1',
    castDate: '2024-07-18',
    status: 'Counted',
    results: 'Published'
}, {
    title: 'Regional Water Authority Seat',
    castDate: '2024-05-06',
    status: 'Counted',
    results: 'Published'
}, {
    title: 'School Board Elections 2024',
    castDate: '2024-04-10',
    status: 'Counted',
    results: 'Published'
}];

// State
let currentView = 'cards'; // or 'table'
let searchTerm = '';
let sortMode = 'endSoon';
let historySortKey = 'title';
let historySortAsc = true;

// Utilities
const fmtDate = (iso) => {
    if (!iso || iso === '—') return '—';
    const d = new Date(iso);
    return d.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
};
const daysUntil = (iso) => {
    const end = new Date(iso).getTime();
    const now = Date.now();
    const diff = end - now;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
};

const toast = (msg) => {
    document.getElementById('toastMsg').textContent = msg;
    const toastEl = document.getElementById('liveToast');
    const t = new bootstrap.Toast(toastEl);
    t.show();
};

// Rendering Active Elections
function getFilteredSortedActive() {
    let data = activeElections.filter(e => (e.title + ' ' + (e.description || '')).toLowerCase().includes(searchTerm));
    if (sortMode === 'alpha') {
        data.sort((a, b) => a.title.localeCompare(b.title));
    } else if (sortMode === 'endLatest') {
        data.sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
    } else { // endSoon
        data.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
    }
    return data;
}

function renderActiveCards() {
    const container = document.getElementById('activeGrid');
    const data = getFilteredSortedActive();
    container.innerHTML = '';
    if (data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-regular fa-face-smile-beam fa-2xl"></i><div class="empty-state-text">No active elections match your search.</div></div>';
        document.getElementById('eligibleCount').textContent = '0';
        return;
    }
    document.getElementById('eligibleCount').textContent = String(data.length);

    data.forEach(e => {
        const dLeft = daysUntil(e.endDate);
        const votedBadge = e.hasVoted ? '<span class="badge-soft success"><i class="fa-solid fa-check-double"></i> Voted</span>' : '';
        const card = document.createElement('div');
        card.className = 'app-card';
        if (e.hasVoted) card.classList.add('election-card-voted');
        card.innerHTML = `
          <div class="card-header">
            <div class="title d-flex align-items-center gap-2">
              <i class="fa-solid fa-box-ballot text-primary"></i> <span class="widget-title">${e.title}</span>
            </div>
            <div>${votedBadge}</div>
          </div>
          <div class="card-body">
            <p class="mb-2">${e.description||''}</p>
            <div class="d-flex align-items-center justify-content-between">
              <div class="text-muted small"><i class="fa-regular fa-clock me-1"></i>Ends: ${fmtDate(e.endDate)} (${dLeft} day${dLeft===1?'':'s'} left)</div>
              <div>
                ${ e.hasVoted
                  ? `<button class="btn btn-success btn-sm" disabled><i class="fa-solid fa-check"></i> Voted</button>`
                  : `<button class="btn btn-primary btn-sm vote-btn" data-id="${e.id}"><i class="fa-solid fa-check-to-slot"></i> Vote Now</button>`
                }
              </div>
            </div>
          </div>`;
        container.appendChild(card);
    });
}

function renderActiveTable() {
    const tbody = document.querySelector('#activeTable tbody');
    const info = document.getElementById('activeTableInfo');
    const sortLabel = document.getElementById('activeSortLabel');
    const data = getFilteredSortedActive();
    tbody.innerHTML = '';
    data.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.title}</td>
          <td>${fmtDate(e.endDate)}</td>
          <td>${ e.hasVoted ? '<span class="badge bg-success-subtle text-success">Voted</span>' : '<span class="badge bg-info-subtle text-info">Open</span>' }</td>
          <td>
            ${ e.hasVoted
              ? `<button class="btn btn-success btn-sm" disabled><i class="fa-solid fa-check"></i> Voted</button>`
              : `<button class="btn btn-primary btn-sm vote-btn" data-id="${e.id}"><i class="fa-solid fa-check-to-slot"></i> Vote Now</button>`
            }
          </td>`;
        tbody.appendChild(tr);
    });
    info.textContent = `Showing ${data.length} of ${data.length}`;
    sortLabel.textContent = sortMode === 'alpha' ? 'A → Z' : (sortMode === 'endLatest' ? 'Ending Latest' : 'Ending Soon');
}

// Rendering Completed Elections
function getFilteredCompleted() {
    return completedElections.filter(e => (e.title).toLowerCase().includes(searchTerm));
}

function renderCompletedCards() {
    const container = document.getElementById('completedGrid');
    const data = getFilteredCompleted();
    container.innerHTML = '';
    if (data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-regular fa-face-meh-blank fa-2xl"></i><div class="empty-state-text">No completed elections match your search.</div></div>';
        return;
    }
    data.forEach(e => {
        const card = document.createElement('div');
        card.className = 'app-card';
        card.innerHTML = `
          <div class="card-header">
            <div class="title d-flex align-items-center gap-2">
              <i class="fa-solid fa-square-poll-horizontal text-primary"></i> <span class="widget-title">${e.title}</span>
            </div>
            <div class="text-muted small"><i class="fa-regular fa-calendar me-1"></i>Ended: ${fmtDate(e.endDate)}</div>
          </div>
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              ${ e.resultsPublished
                ? '<span class="badge-soft success"><i class="fa-solid fa-circle-check"></i> Results Published</span>'
                : '<span class="badge-soft warning"><i class="fa-regular fa-hourglass-half"></i> Results Pending</span>' }
            </div>
            <div>
              ${ e.resultsPublished
                ? `<button class="btn btn-info btn-sm view-results-btn" data-id="${e.id}"><i class="fa-solid fa-chart-simple"></i> View Results</button>`
                : `<button class="btn btn-light btn-sm" disabled><i class="fa-regular fa-hourglass"></i> Results Pending</button>` }
            </div>
          </div>`;
        container.appendChild(card);
    });
}

// Voting history table
function renderHistoryTable() {
    const tbody = document.querySelector('#historyTable tbody');
    const filter = document.getElementById('historyFilter').value.trim().toLowerCase();
    let data = votingHistory.filter(r => r.title.toLowerCase().includes(filter));
    data.sort((a, b) => {
        const av = a[historySortKey];
        const bv = b[historySortKey];
        if (historySortKey === 'castDate') {
            // Handle '—' as nulls at end
            const ad = av === '—' ? 0 : new Date(av).getTime();
            const bd = bv === '—' ? 0 : new Date(bv).getTime();
            return historySortAsc ? ad - bd : bd - ad;
        } else {
            return historySortAsc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
        }
    });
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.title}</td>
          <td>${row.castDate === '—' ? '—' : new Date(row.castDate).toLocaleDateString()}</td>
          <td>${ row.status === 'Counted' ? '<span class="badge bg-success-subtle text-success">Counted</span>' : '<span class="badge bg-warning-subtle text-warning">Did not vote</span>' }</td>
          <td>${ row.results === 'Published' ? '<span class="badge bg-info-subtle text-info">Published</span>' : '<span class="badge bg-warning-subtle text-warning">Pending</span>' }</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('historyInfo').textContent = `Showing 1 to ${data.length} of ${data.length}`;
}

// Chart.js
function renderParticipationChart() {
    const ctx = document.getElementById('participationChart');
    const labels = ['MAY24', 'JUN24', 'JUL24', 'AUG24', 'SEP24', 'OCT24'];
    const voted = [1, 1, 1, 0, 1, 1];
    const missed = voted.map(v => v ? 0 : 1);
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Voted',
                data: voted,
                backgroundColor: 'rgba(0, 119, 78, 0.8)'
            }, {
                label: 'Missed',
                data: missed,
                backgroundColor: 'rgba(255, 165, 0, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                tooltip: {
                    enabled: true
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Event handlers
function attachHandlers() {
    // Vote Now
    document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            Swal.fire({
                title: 'Proceed to Ballot?',
                text: 'You will be redirected to the ballot for this election.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Go to Ballot',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `./ballot_page.html?electionId=${encodeURIComponent(id)}`;
                }
            });
        });
    });
    // View Results
    document.querySelectorAll('.view-results-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            window.location.href = `./voter_results.html?electionId=${encodeURIComponent(id)}`;
        });
    });
}

function renderAllActive() {
    if (currentView === 'cards') {
        document.getElementById('activeGrid').classList.remove('d-none');
        document.getElementById('activeTableWrap').classList.add('d-none');
        renderActiveCards();
    } else {
        document.getElementById('activeGrid').classList.add('d-none');
        document.getElementById('activeTableWrap').classList.remove('d-none');
        renderActiveTable();
    }
    attachHandlers();
}

// Simulate loading
function simulateLoading() {
    const activeLoading = document.getElementById('activeLoading');
    const completedLoading = document.getElementById('completedLoading');
    activeLoading.classList.remove('d-none');
    completedLoading.classList.remove('d-none');
    setTimeout(() => {
        activeLoading.classList.add('d-none');
        completedLoading.classList.add('d-none');
        renderAllActive();
        renderCompletedCards();
        renderHistoryTable();
    }, 800);
}

// Header interactions
document.addEventListener('DOMContentLoaded', () => {
    // Apply user name (mock from session/JWT)
    const name = 'John Doe';
    document.getElementById('voterName').textContent = name;
    document.getElementById('headerUserName').textContent = name;

    // Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        Swal.fire({
            title: 'Log out?',
            text: 'This will end your session.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Logout',
            cancelButtonText: 'Cancel'
        }).then(result => {
            if (result.isConfirmed) {
                // Simulate API call to invalidate session
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 300);
            }
        });
    });

    // Search & Sort
    document.getElementById('searchInput').addEventListener('input', (e) => {
        searchTerm = e.target.value.trim().toLowerCase();
        renderAllActive();
        renderCompletedCards();
    });
    document.getElementById('sortSelect').addEventListener('change', (e) => {
        sortMode = e.target.value;
        renderAllActive();
    });

    // View switcher
    document.getElementById('viewCards').addEventListener('click', () => {
        currentView = 'cards';
        document.getElementById('viewCards').classList.add('active');
        document.getElementById('viewTable').classList.remove('active');
        renderAllActive();
    });
    document.getElementById('viewTable').addEventListener('click', () => {
        currentView = 'table';
        document.getElementById('viewTable').classList.add('active');
        document.getElementById('viewCards').classList.remove('active');
        renderAllActive();
    });

    // History table filter
    document.getElementById('historyFilter').addEventListener('input', renderHistoryTable);
    document.querySelectorAll('#historyTable thead .sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-key');
            if (historySortKey === key) {
                historySortAsc = !historySortAsc;
            } else {
                historySortKey = key;
                historySortAsc = true;
            }
            document.getElementById('historySortLabel').textContent = key === 'castDate' ? 'Date Cast' : 'Election';
            renderHistoryTable();
        });
    });

    // Refresh
    document.getElementById('refreshBtn').addEventListener('click', () => {
        toast('Elections refreshed');
        simulateLoading();
    });

    // Hash-based tab activation
    const hash = window.location.hash.replace('#', '');
    if (hash === 'completed') {
        const tabTrigger = document.querySelector('#completed-tab');
        new bootstrap.Tab(tabTrigger).show();
    }

    simulateLoading();
    renderParticipationChart();
});
  </script>
 </body>
</html>
