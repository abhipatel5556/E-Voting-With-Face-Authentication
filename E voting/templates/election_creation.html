<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Election Creation | Admin Console
  </title>
  <!-- Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome 6 -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
   <!-- Flatpickr (DateTime Picker) -->
   <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
   <!-- SweetAlert2 CSS (optional for theming) -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet"/>
   <!-- Global Theme CSS -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page specific CSS -->
   <link href="static/election_creation.css" rel="stylesheet"/>
  </link>
 </head>
 <body>
  <!-- Admin Header: Provided common component (needed for admin creation page) -->
  <nav class="navbar navbar-expand-lg app-header-admin shadow-sm">
   <div class="container-fluid">
    <button aria-controls="appSidebarAdmin" aria-expanded="false" aria-label="Toggle sidebar" class="btn btn-outline-light d-lg-none me-2" data-bs-target="#appSidebarAdmin" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./admin_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand/28/28'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
     Admin Console
    </a>
    <button aria-controls="adminNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#adminNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="adminNav">
     <form action="./elections_list.html" class="d-none d-md-flex ms-auto me-3" role="search">
      <div class="input-group input-group-sm">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search" class="form-control" name="q" placeholder="Search elections or voters" type="search"/>
      </div>
     </form>
     <ul class="navbar-nav align-items-center">
      <li class="nav-item me-2 d-none d-md-block">
       <a class="btn btn-light btn-sm" href="./election_creation.html">
        <i class="fa-solid fa-plus me-1">
        </i>
        Create Election
       </a>
      </li>
      <li class="nav-item me-2 position-relative">
       <a aria-label="Notifications" class="nav-link" href="#">
        <i class="fa-regular fa-bell">
        </i>
        <span class="notif-dot">
        </span>
       </a>
      </li>
      <li class="nav-item dropdown">
       <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="adminProfileMenu" role="button">
        <img alt="Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=40" style="width:28px;height:28px"/>
        <span>
         Alex Smith
        </span>
       </a>
       <ul class="dropdown-menu dropdown-menu-end">
        <li>
         <h6 class="dropdown-header">
          Administrator
         </h6>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-gear me-2">
          </i>
          Settings
         </a>
        </li>
        <li>
         <a class="dropdown-item" href="#" onclick="return false;">
          <i class="fa-solid fa-book-open-reader me-2">
          </i>
          Admin Guide
         </a>
        </li>
        <li>
         <hr class="dropdown-divider"/>
        </li>
        <li>
         <a class="dropdown-item" href="./index.html">
          <i class="fa-solid fa-right-from-bracket me-2">
          </i>
          Logout
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <div class="d-flex">
   <!-- Admin Sidebar: Provided common component (needed on this page) -->
   <aside class="app-sidebar-admin collapse d-lg-block show" id="appSidebarAdmin">
    <div class="brand d-flex align-items-center p-3">
     <a class="text-decoration-none d-flex align-items-center" href="./admin_dashboard.html">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand2/26/26'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:26px"/>
      <span class="fw-semibold text-dark">
       Admin Console
      </span>
     </a>
    </div>
    <div class="p-3">
     <div class="d-flex align-items-center mb-3">
      <img alt="Admin Avatar" class="rounded-circle me-2" src="https://www.gravatar.com/avatar?d=mp&amp;s=64" style="width:40px;height:40px"/>
      <div>
       <div class="fw-semibold" id="adminName">
        Alex Smith
       </div>
       <div class="text-muted small">
        Administrator
       </div>
      </div>
     </div>
     <div class="mb-2 section-title text-uppercase">
      Overview
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./admin_dashboard.html">
        <i class="fa-solid fa-gauge-high fa-fw me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Elections
     </div>
     <ul class="nav flex-column mb-1">
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html">
        <i class="fa-solid fa-list-check fa-fw me-2">
        </i>
        All Elections
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link active" href="./election_creation.html">
        <i class="fa-solid fa-plus fa-fw me-2">
        </i>
        Create New
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html?status=active">
        <i class="fa-solid fa-signal fa-fw me-2">
        </i>
        Active &amp; Monitoring
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./elections_list.html?status=completed">
        <i class="fa-solid fa-chart-column fa-fw me-2">
        </i>
        Completed &amp; Results
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase mt-3">
      Voters
     </div>
     <ul class="nav flex-column mb-3">
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html">
        <i class="fa-solid fa-users fa-fw me-2">
        </i>
        Manage Voters
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./voter_management.html?status=pending">
        <i class="fa-solid fa-user-check fa-fw me-2">
        </i>
        Pending Approvals
       </a>
      </li>
     </ul>
     <div class="mb-2 section-title text-uppercase">
      Resources
     </div>
     <ul class="nav flex-column">
      <li class="nav-item">
       <a class="nav-link" href="./admin_guide.html" onclick="return false;">
        <i class="fa-solid fa-book-open-reader fa-fw me-2">
        </i>
        Admin Guide
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./privacy.html">
        <i class="fa-solid fa-shield-halved fa-fw me-2">
        </i>
        Privacy
       </a>
      </li>
     </ul>
    </div>
   </aside>
   <!-- Main Content -->
   <main class="flex-grow-1">
    <div class="container-fluid py-3 py-lg-4">
     <!-- Breadcrumbs -->
     <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
       <li class="breadcrumb-item">
        <a href="./admin_dashboard.html">
         Admin Dashboard
        </a>
       </li>
       <li class="breadcrumb-item">
        <a href="./elections_list.html">
         Elections
        </a>
       </li>
       <li aria-current="page" class="breadcrumb-item active">
        Create New Election
       </li>
      </ol>
     </nav>
     <!-- Page Header -->
     <div class="page-header mb-3">
      <div class="d-flex align-items-center gap-2">
       <h1 class="page-title m-0">
        Create New Election
       </h1>
       <span class="badge-soft primary">
        Setup
       </span>
      </div>
      <div class="d-none d-md-flex align-items-center gap-2">
       <button class="btn btn-light btn-sm" id="btnSaveDraftTop">
        <i class="fa-regular fa-floppy-disk me-1">
        </i>
        Save Draft
       </button>
       <a class="btn btn-outline-secondary btn-sm" href="./elections_list.html">
        <i class="fa-solid fa-arrow-left me-1">
        </i>
        Back to List
       </a>
      </div>
     </div>
     <!-- System feedback / notifications area -->
     <div class="alert alert-info d-none" id="systemFeedback" role="alert">
      <i class="fa-solid fa-circle-info me-1">
      </i>
      Tip: Complete all sections. You can save a draft at any time.
     </div>
     <!-- Election Setup Form -->
     <form class="app-card mb-4" id="electionSetupForm">
      <div class="card-header">
       <div class="title d-flex align-items-center gap-2">
        <i class="fa-solid fa-list-check text-primary">
        </i>
        <span class="widget-title">
         Election Setup
        </span>
       </div>
       <div class="text-muted small">
        Follow the steps below
       </div>
      </div>
      <div class="card-body">
       <div class="accordion" id="setupAccordion">
        <!-- Details Section -->
        <div class="accordion-item">
         <h2 class="accordion-header" id="headingDetails">
          <button aria-controls="collapseDetails" aria-expanded="true" class="accordion-button" data-bs-target="#collapseDetails" data-bs-toggle="collapse" type="button">
           1. Details
          </button>
         </h2>
         <div aria-labelledby="headingDetails" class="accordion-collapse collapse show" data-bs-parent="#setupAccordion" id="collapseDetails">
          <div class="accordion-body">
           <div class="row g-3">
            <div class="col-12">
             <label class="form-label" for="electionTitle">
              Election Title
              <span class="text-danger">
               *
              </span>
             </label>
             <input class="form-control" id="electionTitle" maxlength="255" placeholder="e.g., Student Government President 2026" required="" type="text">
              <div class="form-text" id="titleHelp">
               Must not be empty. Max 255 characters.
              </div>
              <div class="invalid-feedback" id="titleError">
               Please enter an election title.
              </div>
             </input>
            </div>
            <div class="col-12">
             <label class="form-label" for="electionDescription">
              Description / Instructions
             </label>
             <textarea class="form-control" id="electionDescription" placeholder="Provide a brief overview of the election..." rows="4"></textarea>
            </div>
            <div class="col-md-6">
             <label class="form-label" for="startDate">
              Start Date &amp; Time
              <span class="text-danger">
               *
              </span>
             </label>
             <input class="form-control" id="startDate" placeholder="Select start date &amp; time" type="text"/>
             <div class="invalid-feedback" id="startDateError">
              Start date must be in the future and before the end date.
             </div>
            </div>
            <div class="col-md-6">
             <label class="form-label" for="endDate">
              End Date &amp; Time
              <span class="text-danger">
               *
              </span>
             </label>
             <input class="form-control" id="endDate" placeholder="Select end date &amp; time" type="text"/>
             <div class="invalid-feedback" id="endDateError">
              End date must be after the start date.
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
        <!-- Candidates Section -->
        <div class="accordion-item">
         <h2 class="accordion-header" id="headingCandidates">
          <button aria-controls="collapseCandidates" aria-expanded="false" class="accordion-button collapsed" data-bs-target="#collapseCandidates" data-bs-toggle="collapse" type="button">
           2. Candidates
          </button>
         </h2>
         <div aria-labelledby="headingCandidates" class="accordion-collapse collapse" data-bs-parent="#setupAccordion" id="collapseCandidates">
          <div class="accordion-body">
           <div class="row g-3 align-items-end">
            <div class="col-md-5">
             <label class="form-label" for="candidateName">
              Candidate Name
             </label>
             <input class="form-control" id="candidateName" placeholder="Enter candidate name" type="text"/>
            </div>
            <div class="col-md-5">
             <label class="form-label" for="candidatePhoto">
              Photo URL (optional)
             </label>
             <input class="form-control" id="candidatePhoto" placeholder="https://example.com/photo.jpg" type="url"/>
            </div>
            <div class="col-md-2 d-grid">
             <button class="btn btn-success" data-bs-title="Enter a name to enable" data-bs-toggle="tooltip" disabled="" id="btnAddCandidate" type="button">
              <i class="fa-solid fa-user-plus me-1">
              </i>
              Add
             </button>
            </div>
           </div>
           <div class="mt-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
             <div class="text-muted small">
              Add at least 2 candidates before publishing.
             </div>
             <div class="text-muted small" id="candidateCount">
              0 candidates
             </div>
            </div>
            <div class="table-responsive">
             <table class="table table-theme align-middle" id="candidatesTable">
              <thead>
               <tr>
                <th style="width:64px">
                 Photo
                </th>
                <th>
                 Name
                </th>
                <th style="width:120px">
                 Actions
                </th>
               </tr>
              </thead>
              <tbody>
               <!-- Populated by JS -->
              </tbody>
             </table>
            </div>
           </div>
          </div>
         </div>
        </div>
        <!-- Voters Section -->
        <div class="accordion-item">
         <h2 class="accordion-header" id="headingVoters">
          <button aria-controls="collapseVoters" aria-expanded="false" class="accordion-button collapsed" data-bs-target="#collapseVoters" data-bs-toggle="collapse" type="button">
           3. Voters
          </button>
         </h2>
         <div aria-labelledby="headingVoters" class="accordion-collapse collapse" data-bs-parent="#setupAccordion" id="collapseVoters">
          <div class="accordion-body">
           <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <div class="input-group" style="max-width:380px">
             <span class="input-group-text">
              <i class="fa-solid fa-magnifying-glass">
              </i>
             </span>
             <input class="form-control" id="voterSearch" placeholder="Search approved voters by name or ID" type="text"/>
            </div>
            <div class="input-group" style="max-width:260px">
             <span class="input-group-text">
              <i class="fa-solid fa-arrow-up-wide-short">
              </i>
             </span>
             <select class="form-select" id="voterSort">
              <option value="name-asc">
               Sort: Name A→Z
              </option>
              <option value="name-desc">
               Sort: Name Z→A
              </option>
              <option value="id-asc">
               Sort: ID Asc
              </option>
              <option value="id-desc">
               Sort: ID Desc
              </option>
             </select>
            </div>
            <div class="ms-auto d-flex gap-2">
             <label class="btn btn-outline-secondary mb-0" for="csvImportInput">
              <i class="fa-solid fa-file-arrow-up me-1">
              </i>
              Import CSV
             </label>
             <input accept=".csv" hidden="" id="csvImportInput" type="file">
             </input>
            </div>
           </div>
           <div class="d-flex align-items-center gap-2 text-muted mb-3" id="voterLoader">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
            </div>
            <span>
             Loading approved voters…
            </span>
           </div>
           <div class="dual-list grid" id="voterDualList" style="display:none">
            <div class="row g-3">
             <div class="col-12 col-lg-5">
              <div class="card h-100">
               <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">
                 Available Voters
                </span>
                <small class="text-muted" id="availableMeta">
                 —
                </small>
               </div>
               <div class="card-body p-0">
                <div class="list-wrapper">
                 <ul class="list-group list-group-flush" id="availableList" style="max-height:360px;overflow:auto">
                 </ul>
                </div>
               </div>
               <div class="card-footer d-flex justify-content-between align-items-center small text-muted">
                <div id="availablePagination">
                 Showing 0-0 of 0
                </div>
                <div class="d-flex align-items-center gap-1">
                 <label class="me-1" for="pageSize">
                  Per page
                 </label>
                 <select class="form-select form-select-sm" id="pageSize" style="width:80px">
                  <option>
                   10
                  </option>
                  <option>
                   15
                  </option>
                  <option selected="">
                   20
                  </option>
                  <option>
                   50
                  </option>
                 </select>
                </div>
               </div>
              </div>
             </div>
             <div class="col-12 col-lg-2 d-flex flex-column align-items-center justify-content-center gap-2">
              <button class="btn btn-primary w-100" id="btnAddSelected" type="button">
               <i class="fa-solid fa-angles-right me-1">
               </i>
               Add
              </button>
              <button class="btn btn-light w-100" id="btnRemoveSelected" type="button">
               <i class="fa-solid fa-angles-left me-1">
               </i>
               Remove
              </button>
             </div>
             <div class="col-12 col-lg-5">
              <div class="card h-100">
               <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">
                 Selected for this Election
                </span>
                <small class="text-muted" id="selectedMeta">
                 —
                </small>
               </div>
               <div class="card-body p-0">
                <div class="list-wrapper">
                 <ul class="list-group list-group-flush" id="selectedList" style="max-height:360px;overflow:auto">
                 </ul>
                </div>
               </div>
               <div class="card-footer text-muted small">
                Select at least one voter before publishing.
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      <!-- Sticky form actions bar -->
      <div class="card-footer form-actions-bar">
       <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="text-muted small">
         <i class="fa-regular fa-circle-question me-1">
         </i>
         Need help? See the Admin Guide.
        </div>
        <div class="ms-auto d-flex gap-2">
         <a class="btn btn-light" href="./elections_list.html" id="btnCancel">
          <i class="fa-solid fa-xmark me-1">
          </i>
          Cancel
         </a>
         <button class="btn btn-secondary" id="btnSaveDraft" type="button">
          <i class="fa-regular fa-floppy-disk me-1">
          </i>
          Save as Draft
         </button>
         <button class="btn btn-primary" id="btnPublish" type="button">
          <i class="fa-solid fa-paper-plane me-1">
          </i>
          Publish Election
         </button>
        </div>
       </div>
      </div>
     </form>
     <!-- Info callouts -->
     <div class="alert alert-warning" role="alert">
      <i class="fa-solid fa-triangle-exclamation me-1">
      </i>
      Before publishing, verify the date/time windows and voter eligibility.
     </div>
    </div>
   </main>
  </div>
  <!-- Admin Footer: Provided common component (needed on admin pages) -->
  <footer class="app-footer-admin py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="mb-2 mb-md-0">
     <a class="btn btn-outline-secondary btn-sm me-2" href="./election_creation.html">
      <i class="fa-solid fa-plus me-1">
      </i>
      Create Election
     </a>
     <a class="btn btn-outline-secondary btn-sm" href="./voter_management.html">
      <i class="fa-solid fa-users me-1">
      </i>
      Manage Voters
     </a>
    </div>
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand3/18/18'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:18px"/>
     <small class="me-3">
      © 2025 FaceID Voting
     </small>
     <a class="small me-3" href="./terms.html">
      Terms
     </a>
     <a class="small" href="./privacy.html">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Toast container (for optional system feedback) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
   <div aria-atomic="true" aria-live="assertive" class="toast align-items-center text-bg-primary border-0" id="liveToast" role="alert">
    <div class="d-flex">
     <div class="toast-body">
      Draft saved successfully.
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- JS: Bootstrap Bundle (with Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- JS: SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js">
  </script>
  <!-- JS: Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr">
  </script>
  <script>
   // Typography: ensure Poppins on this page
document.body.style.fontFamily = "Poppins, var(--font-sans)";

// Enable tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

// Init Flatpickr for datetime fields
const now = new Date();
const startPicker = flatpickr('#startDate', {
    enableTime: true,
    dateFormat: 'Y-m-d H:i',
    minDate: now,
    onChange: validateDates
});
const endPicker = flatpickr('#endDate', {
    enableTime: true,
    dateFormat: 'Y-m-d H:i',
    minDate: now,
    onChange: validateDates
});

// State
let formDirty = false;
let candidates = [{
    id: crypto.randomUUID(),
    name: 'Alice Johnson',
    photo: 'https://picsum.photos/seed/alice/64/64'
}, {
    id: crypto.randomUUID(),
    name: 'Bob Smith',
    photo: 'https://picsum.photos/seed/bob/64/64'
}];

let allVoters = []; // fetched list
let filteredVoters = []; // after search/sort
let selectedVoters = []; // chosen for this election
let currentPage = 1;
let pageSize = 20;

// DOM refs
const elCandidateName = document.getElementById('candidateName');
const elCandidatePhoto = document.getElementById('candidatePhoto');
const elBtnAddCandidate = document.getElementById('btnAddCandidate');
const elCandidatesTableBody = document.querySelector('#candidatesTable tbody');
const elCandidateCount = document.getElementById('candidateCount');

const elVoterLoader = document.getElementById('voterLoader');
const elVoterDual = document.getElementById('voterDualList');
const elVoterSearch = document.getElementById('voterSearch');
const elVoterSort = document.getElementById('voterSort');
const elPageSize = document.getElementById('pageSize');
const elAvailableList = document.getElementById('availableList');
const elSelectedList = document.getElementById('selectedList');
const elAvailablePagination = document.getElementById('availablePagination');
const elAvailableMeta = document.getElementById('availableMeta');
const elSelectedMeta = document.getElementById('selectedMeta');

const elTitle = document.getElementById('electionTitle');
const elTitleError = document.getElementById('titleError');
const elStartError = document.getElementById('startDateError');
const elEndError = document.getElementById('endDateError');

// Input events to set dirty state
document.getElementById('electionSetupForm').addEventListener('input', () => formDirty = true);

// Candidate: enable Add when name present
elCandidateName.addEventListener('input', () => {
    elBtnAddCandidate.disabled = elCandidateName.value.trim().length === 0;
});

// Add candidate
elBtnAddCandidate.addEventListener('click', () => {
    const name = elCandidateName.value.trim();
    if (!name) return;
    const photo = elCandidatePhoto.value.trim() || `https://picsum.photos/seed/${encodeURIComponent(name)}/64/64`;
    candidates.push({
        id: crypto.randomUUID(),
        name,
        photo
    });
    elCandidateName.value = '';
    elCandidatePhoto.value = '';
    elBtnAddCandidate.disabled = true;
    renderCandidates();
    formDirty = true;
});

function removeCandidate(id) {
    candidates = candidates.filter(c => c.id !== id);
    renderCandidates();
    formDirty = true;
}

function renderCandidates() {
    elCandidatesTableBody.innerHTML = '';
    candidates.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <img src="${c.photo}" alt="${c.name}" class="candidate-photo rounded" width="48" height="48" onerror="this.onerror=null;this.src='https://picsum.photos/seed/fallback/64/64'">
          </td>
          <td class="fw-semibold">${c.name}</td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-title="Remove" onclick="removeCandidate('${c.id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>`;
        elCandidatesTableBody.appendChild(tr);
    });
    elCandidateCount.textContent = `${candidates.length} candidate${candidates.length !== 1 ? 's' : ''}`;
    // re-enable tooltips for dynamic content
    [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(el => new bootstrap.Tooltip(el));
}

// Initial render
renderCandidates();

// Simulate API fetch for approved voters
setTimeout(() => {
    allVoters = generateMockVoters(42); // 42 mock voters
    filteredVoters = allVoters.slice();
    elVoterLoader.style.display = 'none';
    elVoterDual.style.display = '';
    renderVoterLists();
}, 800);

function generateMockVoters(count) {
    const list = [];
    for (let i = 1; i <= count; i++) {
        const id = 1000 + i;
        list.push({
            id,
            name: `Voter ${i.toString().padStart(2, '0')}`
        });
    }
    // Add some realistic names
    list[0] = {
        id: 1001,
        name: 'Jordan Lee'
    };
    list[1] = {
        id: 1002,
        name: 'Priya Natarajan'
    };
    list[2] = {
        id: 1003,
        name: 'Carlos Mendes'
    };
    list[3] = {
        id: 1004,
        name: 'Ava Thompson'
    };
    list[4] = {
        id: 1005,
        name: 'Noah Williams'
    };
    list[5] = {
        id: 1006,
        name: 'Mia Chen'
    };
    return list;
}

// Search, sort, page size listeners
elVoterSearch.addEventListener('input', () => {
    currentPage = 1;
    applyFilterSort();
    renderVoterLists();
});
elVoterSort.addEventListener('change', () => {
    applyFilterSort();
    renderVoterLists();
});
elPageSize.addEventListener('change', () => {
    pageSize = parseInt(elPageSize.value, 10);
    currentPage = 1;
    renderVoterLists();
});

function applyFilterSort() {
    const term = elVoterSearch.value.trim().toLowerCase();
    filteredVoters = allVoters.filter(v => v.name.toLowerCase().includes(term) || String(v.id).includes(term));
    const sort = elVoterSort.value;
    const [field, dir] = sort.split('-');
    filteredVoters.sort((a, b) => {
        let va = a[field],
            vb = b[field];
        if (typeof va === 'string') {
            va = va.toLowerCase();
            vb = vb.toLowerCase();
        }
        if (va < vb) return dir === 'asc' ? -1 : 1;
        if (va > vb) return dir === 'asc' ? 1 : -1;
        return 0;
    });
}

function renderVoterLists() {
    // Available list = filteredVoters minus selected
    const selectedIds = new Set(selectedVoters.map(v => v.id));
    const available = filteredVoters.filter(v => !selectedIds.has(v.id));
    const total = available.length;
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = Math.min(startIdx + pageSize, total);
    const pageItems = available.slice(startIdx, endIdx);

    // Render available
    elAvailableList.innerHTML = '';
    pageItems.forEach(v => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        li.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <input class="form-check-input" type="checkbox" value="${v.id}" aria-label="Select ${v.name}">
            <div>
              <div class="fw-semibold">${v.name}</div>
              <div class="text-muted small">ID: ${v.id}</div>
            </div>
          </div>`;
        elAvailableList.appendChild(li);
    });

    elAvailablePagination.textContent = `Showing ${total === 0 ? 0 : startIdx + 1}-${endIdx} of ${total}`;
    elAvailableMeta.textContent = `${total} available`;

    // Render selected
    elSelectedList.innerHTML = '';
    selectedVoters.forEach(v => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        li.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <input class="form-check-input" type="checkbox" value="${v.id}" aria-label="Unselect ${v.name}">
            <div>
              <div class="fw-semibold">${v.name}</div>
              <div class="text-muted small">ID: ${v.id}</div>
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-light" title="Remove" onclick="removeSelectedVoter(${v.id})"><i class="fa-solid fa-trash"></i></button>`;
        elSelectedList.appendChild(li);
    });
    elSelectedMeta.textContent = `${selectedVoters.length} selected`;
}

// Pagination simple next/prev could be added; keeping single page controls via page size and search.

// Add selected voters
document.getElementById('btnAddSelected').addEventListener('click', () => {
    const checks = elAvailableList.querySelectorAll('input[type="checkbox"]:checked');
    const ids = Array.from(checks).map(c => parseInt(c.value, 10));
    if (!ids.length) return;
    const map = new Map(allVoters.map(v => [v.id, v]));
    ids.forEach(id => {
        const v = map.get(id);
        if (v && !selectedVoters.some(s => s.id === id)) selectedVoters.push(v);
    });
    formDirty = true;
    renderVoterLists();
});

// Remove selected voters
document.getElementById('btnRemoveSelected').addEventListener('click', () => {
    const checks = elSelectedList.querySelectorAll('input[type="checkbox"]:checked');
    const ids = new Set(Array.from(checks).map(c => parseInt(c.value, 10)));
    if (!ids.size) return;
    selectedVoters = selectedVoters.filter(v => !ids.has(v.id));
    formDirty = true;
    renderVoterLists();
});

// Remove single selected voter via button
window.removeSelectedVoter = function(id) {
    selectedVoters = selectedVoters.filter(v => v.id !== id);
    formDirty = true;
    renderVoterLists();
}

// Import CSV (IDs)
document.getElementById('csvImportInput').addEventListener('change', async (ev) => {
    const file = ev.target.files?.[0];
    if (!file) return;
    try {
        const text = await file.text();
        const ids = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean).map(s => parseInt(s, 10)).filter(n => !isNaN(n));
        const map = new Map(allVoters.map(v => [v.id, v]));
        let added = 0;
        ids.forEach(id => {
            const v = map.get(id);
            if (v && !selectedVoters.some(s => s.id === id)) {
                selectedVoters.push(v);
                added++;
            }
        });
        renderVoterLists();
        formDirty = true;
        Swal.fire({
            icon: 'success',
            title: 'Import complete',
            text: added ? `${added} voters added.` : 'No valid voter IDs found.',
            timer: 2000,
            showConfirmButton: false
        });
    } catch (e) {
        Swal.fire({
            icon: 'error',
            title: 'Import failed',
            text: 'Could not read the CSV file.'
        });
    } finally {
        ev.target.value = '';
    }
});

// Validation helpers
function validateTitle() {
    const ok = elTitle.value.trim().length > 0;
    elTitle.classList.toggle('is-invalid', !ok);
    return ok;
}

function getDates() {
    const s = startPicker.selectedDates?.[0];
    const e = endPicker.selectedDates?.[0];
    return {
        s,
        e
    };
}

function validateDates() {
    const {
        s,
        e
    } = getDates();
    let validStart = !!s && s > new Date();
    let validEnd = !!e && !!s && e > s;
    document.getElementById('startDate').classList.toggle('is-invalid', !validStart);
    document.getElementById('endDate').classList.toggle('is-invalid', !validEnd);
    return validStart && validEnd;
}

function isFormValid() {
    const titleOk = validateTitle();
    const datesOk = validateDates();
    const candidatesOk = candidates.length >= 2;
    const votersOk = selectedVoters.length >= 1;
    if (!candidatesOk) {
        Swal.fire({
            icon: 'warning',
            title: 'Add candidates',
            text: 'Please add at least 2 candidates.'
        });
    } else if (!votersOk) {
        Swal.fire({
            icon: 'warning',
            title: 'Add voters',
            text: 'Please select at least 1 eligible voter.'
        });
    }
    return titleOk && datesOk && candidatesOk && votersOk;
}

// Action buttons
document.getElementById('btnPublish').addEventListener('click', async () => {
    if (!isFormValid()) return;
    const payload = collectPayload('published');
    try {
        // Simulate API call
        await new Promise(res => setTimeout(res, 800));
        Swal.fire({
            icon: 'success',
            title: 'Election Published',
            text: 'Your election is scheduled and will open at the configured start time.',
            confirmButtonText: 'Go to Elections'
        }).then(() => {
            window.location.href = './elections_list.html';
        });
    } catch (e) {
        Swal.fire({
            icon: 'error',
            title: 'Publish failed',
            text: 'Please try again or contact support.'
        });
    }
});

document.getElementById('btnSaveDraft').addEventListener('click', async () => {
    const payload = collectPayload('draft');
    await new Promise(res => setTimeout(res, 500));
    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
    toast.show();
    formDirty = false;
});

document.getElementById('btnSaveDraftTop').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('btnSaveDraft').click();
});

document.getElementById('btnCancel').addEventListener('click', (e) => {
    e.preventDefault();
    if (!formDirty) {
        window.location.href = './elections_list.html';
        return;
    }
    Swal.fire({
        icon: 'question',
        title: 'Discard changes?',
        text: 'You have unsaved changes. Are you sure you want to leave this page?',
        showCancelButton: true,
        confirmButtonText: 'Discard',
        cancelButtonText: 'Stay'
    }).then(res => {
        if (res.isConfirmed) window.location.href = './elections_list.html';
    });
});

function collectPayload(status) {
    const {
        s,
        e
    } = getDates();
    return {
        title: elTitle.value.trim(),
        description: document.getElementById('electionDescription').value.trim(),
        startDate: s ? s.toISOString() : null,
        endDate: e ? e.toISOString() : null,
        candidates: candidates.map(c => ({
            name: c.name,
            photo: c.photo
        })),
        voters: selectedVoters.map(v => v.id),
        status
    };
}

// Validate title on blur
elTitle.addEventListener('blur', validateTitle);
  </script>
  <style>
   /* Sidebar, Header, Footer component styles (as provided) */
    :root { --primary-color:#6144a6; --secondary-color:#ffffff; --hover-bg: rgba(97,68,166,.08); --active-bg: rgba(97,68,166,.14); }
    .app-sidebar-admin{width:260px;background:#fff;border-right:1px solid #eee;min-height:100vh}
    .app-sidebar-admin .brand{border-bottom:1px solid #eee}
    .app-sidebar-admin .nav-link{color:#444;border-radius:.35rem;padding:.5rem .75rem}
    .app-sidebar-admin .nav-link .fa-fw{width:1.25rem}
    .app-sidebar-admin .nav-link:hover{background:var(--hover-bg)}
    .app-sidebar-admin .nav-link.active{background:var(--active-bg);border-left:4px solid var(--primary-color)}
    .app-sidebar-admin .section-title{font-size:.72rem;letter-spacing:.08em;color:#888}
    .app-sidebar-admin .submenu .nav-link{padding-left:2rem}
    @media (max-width: 991.98px){ .app-sidebar-admin{display:none;} }

    .app-header-admin{background:#6144a6;color:#fff}
    .app-header-admin .navbar-brand,.app-header-admin .nav-link,.app-header-admin .dropdown-toggle{color:#fff}
    .app-header-admin .form-control:focus{box-shadow:none;border-color:#ddd}
    .notif-dot{position:absolute;top:.25rem;right:.25rem;width:.5rem;height:.5rem;background:#dc3545;border-radius:50%}

    .app-footer-admin{background:#f8f9fa;border-top:1px solid #eee;color:#555}
    .app-footer-admin a{color:#6144a6;text-decoration:none}
    .app-footer-admin a:hover{text-decoration:underline}
  </style>
 </body>
</html>
