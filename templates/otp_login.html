<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   OTP Login - FaceID Voting
  </title>
  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <!-- App Theme CSS -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page Specific CSS -->
   <link href="static/otp_login.css" rel="stylesheet"/>
   <!-- SweetAlert2 CSS -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet">
   </link>
  </link>
 </head>
 <body>
  <!-- Shared/Public Header with branding and minimal actions -->
  <style>
   .app-header-shared{background:#6144a6;color:#fff}
    .app-header-shared .navbar-brand,.app-header-shared .nav-link,.app-header-shared .dropdown-toggle{color:#fff}
    .app-header-shared .nav-link:hover,.app-header-shared .dropdown-item:hover{opacity:.9}
    .app-header-shared .navbar-toggler{border-color: rgba(255,255,255,.35)}
    .app-header-shared .navbar-toggler-icon{filter: invert(1)}
  </style>
  <nav class="navbar navbar-expand-lg app-header-shared navbar-dark shadow-sm">
   <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="./index.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/faceidlogo/56/28'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px"/>
     FaceID Voting
    </a>
    <button aria-controls="sharedNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#sharedNav" data-bs-toggle="collapse" type="button">
     <span class="navbar-toggler-icon">
     </span>
    </button>
    <div class="collapse navbar-collapse" id="sharedNav">
     <ul class="navbar-nav ms-auto align-items-center">
      <li class="nav-item me-2">
       <a class="btn btn-light btn-sm" href="./index.html">
        <i class="fa-solid fa-right-to-bracket me-1">
        </i>
        Login
       </a>
      </li>
      <li class="nav-item">
       <a class="btn btn-outline-light btn-sm" href="./registration_page.html">
        <i class="fa-solid fa-user-plus me-1">
        </i>
        Register
       </a>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <!-- Main Content -->
  <main class="main-panel" id="main">
   <div class="container">
    <div class="auth-shell d-flex align-items-center justify-content-center py-5">
     <section aria-labelledby="otpTitle" class="login-form-container otp-auth-card w-100">
      <div class="d-flex align-items-center justify-content-between mb-3">
       <div class="d-flex align-items-center gap-2">
        <div class="rounded-circle bg-primary-soft d-flex align-items-center justify-content-center" style="width:40px;height:40px">
         <i class="fa-solid fa-shield-keyhole text-primary">
         </i>
        </div>
        <div>
         <h2 class="m-0" id="otpTitle">
          Check your email
         </h2>
         <small class="text-muted">
          OTP Verification
         </small>
        </div>
       </div>
       <a class="btn btn-light btn-sm" href="./index.html">
        <i class="fa-solid fa-arrow-left-long me-1">
        </i>
        Back
       </a>
      </div>
      <p class="mb-3" id="otpInstruction">
       We've sent a 6-digit code to
       <span class="fw-semibold" id="userEmailText">
        user@example.com
       </span>
       . The code expires shortly.
      </p>
      <div aria-live="polite" class="alert alert-info d-none" id="infoArea" role="status">
       <i class="fa-solid fa-circle-info me-1">
       </i>
       <span id="infoMessage">
        A new OTP has been sent.
       </span>
      </div>
      <div aria-live="assertive" class="alert alert-danger d-none" id="errorArea" role="alert">
       <i class="fa-solid fa-triangle-exclamation me-1">
       </i>
       <span id="errorMessage">
        Invalid or expired code. Please try again.
       </span>
      </div>
      <form autocomplete="one-time-code" class="needs-validation" id="otpForm" novalidate="">
       <div class="mb-3">
        <label class="form-label" for="otpInput">
         One-Time Password
        </label>
        <div class="input-group">
         <span class="input-group-text">
          <i class="fa-solid fa-lock">
          </i>
         </span>
         <input aria-describedby="otpHelp" class="form-control otp-input-field" id="otpInput" inputmode="numeric" maxlength="6" pattern="[0-9]*" placeholder="Enter 6-digit code" required="" type="text"/>
        </div>
        <div class="form-text" id="otpHelp">
         Enter the 6 digits from your email. For demo: use 123456.
        </div>
       </div>
       <div class="d-grid gap-2">
        <button class="btn btn-primary" disabled="" id="verifyBtn" type="submit">
         <span class="btn-label">
          Verify &amp; Log In
         </span>
         <span aria-hidden="true" class="spinner-border spinner-border-sm ms-2 d-none" id="verifySpinner" role="status">
         </span>
        </button>
       </div>
      </form>
      <div class="d-flex align-items-center justify-content-between mt-3">
       <button class="btn btn-link px-0" disabled="" id="resendBtn" type="button">
        Resend Code in
        <span id="resendTimerText">
         60
        </span>
        s
       </button>
       <a class="text-decoration-none" href="./index.html">
        <i class="fa-solid fa-right-to-bracket me-1">
        </i>
        Back to Login
       </a>
      </div>
      <hr class="my-4"/>
      <div class="small text-muted">
       • Didn’t receive the email? Check your spam or promotions folder. If still not received, try resending the code.
       <br/>
       • This is a secure fallback when face recognition isn’t available.
      </div>
     </section>
    </div>
   </div>
  </main>
  <!-- Shared/Public Footer -->
  <style>
   .app-footer{background:#f8f9fa;border-top:1px solid #eee;color:#555}
    .app-footer a{color:#6144a6;text-decoration:none}
    .app-footer a:hover{text-decoration:underline}
  </style>
  <footer class="app-footer py-3 mt-auto">
   <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="d-flex align-items-center mb-2 mb-md-0">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/faceidfooter/40/20'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:20px"/>
     <small>
      © 2025 FaceID Voting
     </small>
    </div>
    <div class="d-flex gap-3">
     <a class="small" href="#" onclick="return false;">
      Terms
     </a>
     <a class="small" href="#" onclick="return false;">
      Privacy
     </a>
     <a class="small" href="#" onclick="return false;">
      Support
     </a>
    </div>
   </div>
  </footer>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js">
  </script>
  <!-- Bootstrap 5 JS -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- Page Script: OTP Login -->
  <script>
   (function() {
    const qs = (sel, el = document) => el.querySelector(sel);
    const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));

    const otpInput = qs('#otpInput');
    const verifyBtn = qs('#verifyBtn');
    const verifySpinner = qs('#verifySpinner');
    const resendBtn = qs('#resendBtn');
    const resendTimerText = qs('#resendTimerText');
    const errorArea = qs('#errorArea');
    const errorMessage = qs('#errorMessage');
    const infoArea = qs('#infoArea');
    const infoMessage = qs('#infoMessage');
    const userEmailText = qs('#userEmailText');
    const otpForm = qs('#otpForm');

    let resendTimer = 60;
    let resendInterval = null;

    // Resolve user email from URL -> localStorage -> fallback
    function getUserEmail() {
        const url = new URL(window.location.href);
        const emailParam = url.searchParams.get('email');
        const stored = localStorage.getItem('userEmail');
        const email = emailParam || stored || 'jane.doe@example.com';
        // Save for later pages
        localStorage.setItem('userEmail', email);
        return email;
    }

    function setUserEmail() {
        userEmailText.textContent = getUserEmail();
    }

    function startResendCountdown(seconds) {
        clearInterval(resendInterval);
        resendTimer = seconds;
        updateResendUI();
        resendInterval = setInterval(() => {
            resendTimer--;
            updateResendUI();
            if (resendTimer <= 0) {
                clearInterval(resendInterval);
            }
        }, 1000);
    }

    function updateResendUI() {
        if (resendTimer > 0) {
            resendBtn.disabled = true;
            resendBtn.innerHTML = `Resend Code in <span id="resendTimerText">${resendTimer}</span>s`;
        } else {
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend Code';
        }
    }

    function showError(msg) {
        errorMessage.textContent = msg || 'Invalid or expired code. Please try again.';
        errorArea.classList.remove('d-none');
    }

    function clearError() {
        errorArea.classList.add('d-none');
    }

    function showInfo(msg) {
        infoMessage.textContent = msg || 'A new OTP has been sent to your email.';
        infoArea.classList.remove('d-none');
        setTimeout(() => infoArea.classList.add('d-none'), 5000);
    }

    function setLoading(isLoading) {
        if (isLoading) {
            verifyBtn.setAttribute('disabled', 'disabled');
            verifySpinner.classList.remove('d-none');
        } else {
            verifySpinner.classList.add('d-none');
            // Re-evaluate enabled state based on input length
            if (otpInput.value.length === 6) {
                verifyBtn.removeAttribute('disabled');
            } else {
                verifyBtn.setAttribute('disabled', 'disabled');
            }
        }
    }

    // Input enforcement: digits only, max 6
    function sanitizeOTP(value) {
        return value.replace(/\D+/g, '').slice(0, 6);
    }

    otpInput.addEventListener('input', (e) => {
        const cleaned = sanitizeOTP(e.target.value);
        if (cleaned !== e.target.value) {
            e.target.value = cleaned;
        }
        clearError();
        if (cleaned.length === 6) {
            verifyBtn.removeAttribute('disabled');
        } else {
            verifyBtn.setAttribute('disabled', 'disabled');
        }
    });

    otpInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const cleaned = sanitizeOTP(text);
        otpInput.value = cleaned;
        otpInput.dispatchEvent(new Event('input'));
    });

    otpForm.addEventListener('submit', (e) => {
        e.preventDefault();
        clearError();
        const code = otpInput.value.trim();
        if (code.length !== 6) {
            showError('Please enter the 6-digit code.');
            return;
        }
        setLoading(true);

        // Simulate API call; success for code 123456
        setTimeout(() => {
            const isValid = code === '123456';
            setLoading(false);
            if (isValid) {
                Swal.fire({
                    icon: 'success',
                    title: 'Verified',
                    text: 'Your OTP was verified. Logging you in...',
                    timer: 1400,
                    showConfirmButton: false
                });
                setTimeout(() => {
                    window.location.href = './voter_dashboard.html';
                }, 1400);
            } else {
                showError('Invalid or expired code. Please try again.');
                Swal.fire({
                    icon: 'error',
                    title: 'Verification Failed',
                    text: 'The code you entered is not valid. Please try again.',
                    confirmButtonText: 'OK'
                });
            }
        }, 900);
    });

    resendBtn.addEventListener('click', () => {
        // Simulate resend API
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending...';
        setTimeout(() => {
            showInfo('A new code has been sent to ' + getUserEmail());
            startResendCountdown(60);
        }, 700);
    });

    // Init
    setUserEmail();
    startResendCountdown(60);
    otpInput.focus();
})();
  </script>
 </body>
</html>
