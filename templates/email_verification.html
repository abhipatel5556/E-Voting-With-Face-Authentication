<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   FaceID Voting - Email Verification
  </title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Font Awesome (also included in Header component) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <!-- Global Theme CSS -->
   <link href="static/style.css" rel="stylesheet"/>
   <!-- Page-specific CSS -->
   <link href="static/email_verification.css" rel="stylesheet"/>
  </link>
 </head>
 <body>
  <div class="page-container d-flex flex-column min-vh-100">
   <!-- Shared/Public Header with branding and minimal actions -->
   <style>
    .app-header-shared{background:#6144a6;color:#fff}
      .app-header-shared .navbar-brand,.app-header-shared .nav-link,.app-header-shared .dropdown-toggle{color:#fff}
      .app-header-shared .nav-link:hover,.app-header-shared .dropdown-item:hover{opacity:.9}
   </style>
   <nav class="navbar navbar-expand-lg app-header-shared shadow-sm">
    <div class="container-fluid">
     <a class="navbar-brand d-flex align-items-center" href="/login">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/faceidlogo/64/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;"/>
      FaceID Voting
     </a>
     <button aria-controls="sharedNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#sharedNav" data-bs-toggle="collapse" type="button">
      <span class="navbar-toggler-icon">
      </span>
     </button>
     <div class="collapse navbar-collapse" id="sharedNav">
      <ul class="navbar-nav ms-auto align-items-center">
       <li class="nav-item me-2">
        <a class="btn btn-light btn-sm" href="./index.html">
         <i class="fa-solid fa-right-to-bracket me-1">
         </i>
         Login
        </a>
       </li>
       <li class="nav-item">
        <a class="btn btn-outline-light btn-sm" href="./registration_page.html">
         <i class="fa-solid fa-user-plus me-1">
         </i>
         Register
        </a>
       </li>
      </ul>
     </div>
    </div>
   </nav>
   <div class="flex-grow-1">
    <div class="container-fluid">
     <div class="row g-0">
      <!-- Shared/Public Sidebar (visible on lg and up) -->
      <style>
       :root { --primary-color:#6144a6; --secondary-color:#ffffff; --hover-bg: rgba(97,68,166,.08); --active-bg: rgba(97,68,166,.14); }
            .app-sidebar-shared{width:260px;background:#fff;border-right:1px solid #eee;}
            .app-sidebar-shared .brand-block{background:var(--secondary-color);border-bottom:1px solid #eee}
            .app-sidebar-shared .brand-title{color:#333;font-weight:600}
            .app-sidebar-shared .nav-link{color:#444;border-radius:.35rem;padding:.5rem .75rem}
            .app-sidebar-shared .nav-link:hover{background:var(--hover-bg);color:#222}
            .app-sidebar-shared .nav-link.active{background:var(--active-bg);color:#222}
            @media (max-width: 991.98px){ .app-sidebar-shared{display:none;} }
      </style>
      <aside class="app-sidebar-shared d-none d-lg-block col-lg-auto">
       <div class="brand-block d-flex align-items-center p-3">
        <a class="d-flex align-items-center text-decoration-none" href="/login">
         <img alt="Brand Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brandlogo/56/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:28px;width:auto;">
          <span class="brand-title">
           FaceID Voting
          </span>
         </img>
        </a>
       </div>
       <div class="p-3">
        <div class="d-flex align-items-center mb-3">
         <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width:40px;height:40px;">
          <i class="fa-solid fa-user text-muted">
          </i>
         </div>
         <div>
          <div class="fw-semibold">
           Welcome
          </div>
          <div class="text-muted small">
           Guest
          </div>
         </div>
        </div>
        <small class="text-uppercase text-muted">
         Getting Started
        </small>
        <ul class="nav flex-column mt-2 mb-3">
         <li class="nav-item">
          <a class="nav-link" href="/login">
           <i class="fa-solid fa-right-to-bracket me-2">
           </i>
           Login
          </a>
         </li>
         <li class="nav-item">
          <a class="nav-link" href="/register">
           <i class="fa-solid fa-user-plus me-2">
           </i>
           Register
          </a>
         </li>
         <li class="nav-item">
          <a class="nav-link active" href="/verify-email">
           <i class="fa-solid fa-envelope-open-text me-2">
           </i>
           Email Verification
          </a>
         </li>
        </ul>
        <small class="text-uppercase text-muted">
         Support
        </small>
        <ul class="nav flex-column mt-2">
         <li class="nav-item">
          <a class="nav-link" href="#" onclick="return false;">
           <i class="fa-solid fa-circle-question me-2">
           </i>
           Help
          </a>
         </li>
         <li class="nav-item">
          <a class="nav-link" href="./privacy.html">
           <i class="fa-solid fa-shield-halved me-2">
           </i>
           Privacy Policy
          </a>
         </li>
         <li class="nav-item">
          <a class="nav-link" href="./terms.html">
           <i class="fa-solid fa-scale-balanced me-2">
           </i>
           Terms
          </a>
         </li>
        </ul>
       </div>
      </aside>
      <!-- Main content -->
      <main class="col">
       <div class="container py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="breadcrumb">
         <ol class="breadcrumb mb-3">
          <li class="breadcrumb-item">
           <a href="./registration_page.html">
            Registration
           </a>
          </li>
          <li aria-current="page" class="breadcrumb-item active">
           Verify Email
          </li>
         </ol>
        </nav>
        <div class="row justify-content-center">
         <div class="col-12 col-md-10 col-lg-7">
          <div class="app-card verification-card">
           <div class="card-header">
            <div class="d-flex align-items-center gap-2">
             <i class="fa-solid fa-shield-halved text-primary">
             </i>
             <span class="widget-title">
              Verify Your Email Address
             </span>
            </div>
            <div>
             <a class="btn btn-light btn-sm" href="./index.html">
              <i class="fa-solid fa-right-to-bracket me-1">
              </i>
              Login
             </a>
            </div>
           </div>
           <div class="card-body">
            <!-- Verification Instructions -->
            <div class="d-flex align-items-center mb-3">
             <div class="verification-hero-icon me-3 bg-info-soft rounded-circle d-flex align-items-center justify-content-center">
              <i class="fa-solid fa-envelope text-info">
              </i>
             </div>
             <div>
              <p class="mb-1">
               A verification email has been sent to
              </p>
              <div class="badge-soft info" id="userEmailPill">
               user@example.com
              </div>
             </div>
            </div>
            <p class="text-muted mb-4">
             Please check your inbox (and spam folder) and enter the 6-digit code below to complete your registration. If you received a link, you can click it instead.
            </p>
            <!-- Form -->
            <form id="verificationForm" novalidate="">
             <div class="mb-3">
              <label class="form-label" for="codeInput">
               Verification Code
              </label>
              <div class="input-group">
               <span class="input-group-text">
                <i class="fa-solid fa-key">
                </i>
               </span>
               <input aria-describedby="codeHelp" class="form-control code-input" id="codeInput" inputmode="numeric" maxlength="6" pattern="\\d{6}" placeholder="Enter 6-digit code" required="" type="text"/>
              </div>
              <div class="form-text" id="codeHelp">
               Must be exactly 6 digits.
              </div>
              <div class="invalid-feedback">
               Please enter a valid 6-digit code.
              </div>
             </div>
             <div class="d-flex align-items-center gap-2 mb-3">
              <button class="btn btn-primary" disabled="" id="verifyBtn" type="submit">
               <span class="btn-label">
                Verify Account
               </span>
               <span aria-hidden="true" class="btn-spinner spinner-border spinner-border-sm ms-2 d-none" role="status">
               </span>
              </button>
              <button class="btn btn-light" id="openEmailBtn" type="button">
               <i class="fa-solid fa-arrow-up-right-from-square me-1">
               </i>
               Open Email App
              </button>
             </div>
             <!-- Feedback and Resend -->
             <div aria-live="polite" class="alert alert-danger d-none" id="errorRegion" role="alert">
              <i class="fa-solid fa-triangle-exclamation me-1">
              </i>
              <span id="errorMessage">
               Invalid or expired code. Please try again.
              </span>
             </div>
             <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-primary btn-sm" id="resendBtn" type="button">
               <i class="fa-solid fa-paper-plane me-1">
               </i>
               Resend verification email
              </button>
              <small class="text-muted" id="resendCooldownText">
              </small>
             </div>
            </form>
            <hr class="my-4"/>
            <div class="row g-3">
             <div class="col-12 col-md-6">
              <div class="d-flex align-items-start gap-2">
               <i class="fa-solid fa-circle-info text-info mt-1">
               </i>
               <div class="small text-muted">
                Tip: Searching your inbox for “FaceID Voting” may help locate the email faster.
               </div>
              </div>
             </div>
             <div class="col-12 col-md-6">
              <div class="d-flex align-items-start gap-2">
               <i class="fa-solid fa-rotate text-warning mt-1">
               </i>
               <div class="small text-muted">
                If you entered the wrong email,
                <a href="./registration_page.html">
                 go back to registration
                </a>
                and correct it.
               </div>
              </div>
             </div>
            </div>
           </div>
           <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="text-muted small">
             Having trouble?
             <a href="#" onclick="return false;">
              Contact support
             </a>
            </div>
            <div class="text-muted small">
             Next step: Pending Approval
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </main>
     </div>
    </div>
   </div>
   <!-- Shared/Public Footer -->
   <style>
    .app-footer{background:#f8f9fa;border-top:1px solid #eee;color:#555}
      .app-footer a{color:#6144a6;text-decoration:none}
      .app-footer a:hover{text-decoration:underline}
   </style>
   <footer class="app-footer py-3 mt-auto">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
     <div class="d-flex align-items-center mb-2 mb-md-0">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/faceidfooter/40/20';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68bd9542e1229daa603ec466/logos/logo_94009328-59f7-426f-bafe-3182305ed5e5.webp" style="height:20px"/>
      <small>
       © 2025 FaceID Voting
      </small>
     </div>
     <div class="d-flex gap-3">
      <a class="small" href="./terms.html">
       Terms
      </a>
      <a class="small" href="./privacy.html">
       Privacy
      </a>
      <a class="small" href="#" onclick="return false;">
       Support
      </a>
     </div>
    </div>
   </footer>
  </div>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <!-- Bootstrap 5 Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
    const emailPill = document.getElementById('userEmailPill');
    const codeInput = document.getElementById('codeInput');
    const verifyBtn = document.getElementById('verifyBtn');
    const btnSpinner = document.querySelector('.btn-spinner');
    const btnLabel = document.querySelector('.btn-label');
    const form = document.getElementById('verificationForm');
    const errorRegion = document.getElementById('errorRegion');
    const errorMessage = document.getElementById('errorMessage');
    const resendBtn = document.getElementById('resendBtn');
    const cooldownText = document.getElementById('resendCooldownText');
    const openEmailBtn = document.getElementById('openEmailBtn');

    // Resolve user email from URL or storage
    const params = new URLSearchParams(window.location.search);
    let userEmail = params.get('email') || localStorage.getItem('pendingEmail') || 'user@example.com';
    emailPill.textContent = userEmail;

    // Utility: Validate code
    function isValidCode(value) {
        return /^\d{6}$/.test(value);
    }

    // Enable/disable verify button based on input
    function updateBtnState() {
        const clean = codeInput.value.replace(/\D/g, '').slice(0, 6);
        verifyBtn.disabled = !isValidCode(clean);
    }

    // Input handlers
    codeInput.addEventListener('input', (e) => {
        const digitsOnly = e.target.value.replace(/\D/g, '').slice(0, 6);
        e.target.value = digitsOnly;
        if (e.target.classList.contains('is-invalid')) {
            e.target.classList.remove('is-invalid');
            errorRegion.classList.add('d-none');
        }
        updateBtnState();
    });

    codeInput.addEventListener('blur', () => {
        if (codeInput.value && !isValidCode(codeInput.value)) {
            codeInput.classList.add('is-invalid');
        }
    });

    // Submit verification
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const code = codeInput.value;
        if (!isValidCode(code)) {
            codeInput.classList.add('is-invalid');
            return;
        }
        // Loading state
        verifyBtn.disabled = true;
        btnSpinner.classList.remove('d-none');
        btnLabel.textContent = 'Verifying...';

        // Simulate API request (replace with real fetch to backend)
        setTimeout(() => {
            const success = Math.random() > 0.2; // 80% success rate simulation
            btnSpinner.classList.add('d-none');
            btnLabel.textContent = 'Verify Account';
            if (success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Email Verified',
                    text: 'Your email has been successfully verified. Proceeding to Pending Approval...',
                    timer: 1800,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = './pending_approval.html';
                });
            } else {
                verifyBtn.disabled = false;
                errorMessage.textContent = 'Invalid or expired code. Please try again.';
                errorRegion.classList.remove('d-none');
                codeInput.classList.add('is-invalid');
            }
        }, 1200);
    });

    // Resend logic with cooldown
    const COOLDOWN_SECONDS = 60;

    function getCooldownEnd() {
        const saved = localStorage.getItem('verificationResendCooldownEnd');
        return saved ? parseInt(saved, 10) : 0;
    }

    function setCooldown() {
        const end = Date.now() + COOLDOWN_SECONDS * 1000;
        localStorage.setItem('verificationResendCooldownEnd', String(end));
    }
    let countdownTimer = null;

    function updateCooldownUI() {
        const end = getCooldownEnd();
        const remainingMs = end - Date.now();
        if (remainingMs > 0) {
            resendBtn.disabled = true;
            cooldownText.textContent = `Resend available in ${Math.ceil(remainingMs/1000)}s`;
            if (!countdownTimer) {
                countdownTimer = setInterval(() => {
                    const r = getCooldownEnd() - Date.now();
                    if (r <= 0) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                        resendBtn.disabled = false;
                        cooldownText.textContent = '';
                    } else {
                        cooldownText.textContent = `Resend available in ${Math.ceil(r/1000)}s`;
                    }
                }, 1000);
            }
        } else {
            resendBtn.disabled = false;
            cooldownText.textContent = '';
        }
    }
    updateCooldownUI();

    resendBtn.addEventListener('click', function() {
        if (resendBtn.disabled) return;
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        // Simulate API call
        setTimeout(() => {
            const success = Math.random() > 0.1; // 90% success simulation
            resendBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-1"></i> Resend verification email';
            if (success) {
                setCooldown();
                updateCooldownUI();
                Swal.fire({
                    icon: 'success',
                    title: 'Verification Email Sent',
                    text: `A new code was sent to ${userEmail}.`,
                    timer: 1600,
                    showConfirmButton: false
                });
            } else {
                resendBtn.disabled = false;
                Swal.fire({
                    icon: 'error',
                    title: 'Unable to resend',
                    text: 'Please wait a moment and try again.'
                });
            }
        }, 900);
    });

    // Open Email App - basic approach
    openEmailBtn.addEventListener('click', () => {
        // Try generic mailto to prompt default email client
        window.location.href = `mailto:${encodeURIComponent(userEmail)}?subject=${encodeURIComponent('Verification Code')}`;
    });
});
  </script>
 </body>
</html>
